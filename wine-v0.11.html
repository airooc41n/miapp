<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasaporte del Vino - v0.11</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <style>
        /* CSS ORIGINAL PRESERVADO */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { display: flex; flex-direction: column; height: 100vh; overflow: hidden; background-color: #f4f7fa; color: #333; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: #5e0b15; color: white; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); position: fixed; width: 100%; top: 0; z-index: 1000; }
        .logo { font-size: 1.5em; font-weight: bold; }
        .hamburger { cursor: pointer; font-size: 1.8em; }
        
        #menu { position: fixed; top: 0; right: -60%; width: 60%; height: 100%; background-color: #ffffff; box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2); transition: right 0.3s ease-in-out; z-index: 2000; padding: 60px 20px 20px; overflow-y: auto; }
        #menu.active { right: 0; }
        #menu .close { position: absolute; top: 15px; right: 20px; font-size: 1.8em; cursor: pointer; }
        #menu ul { list-style: none; }
        #menu li { margin: 15px 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        #menu a { text-decoration: none; color: #333; font-size: 1.1em; display: block; }
        
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; z-index: 1500; }
        #overlay.active { display: block; }
        
        main { flex: 1; padding: 80px 20px 80px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; }
        
        h1 { color: #5e0b15; margin-bottom: 15px; text-align: center; }
        h2 { color: #5e0b15; margin: 20px 0 10px; font-size: 1.3em; }
        p { line-height: 1.6; margin-bottom: 15px; text-align: justify; }
        
        .cta-button { background-color: #5e0b15; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-size: 1.1em; margin-top: 10px; transition: background 0.3s; }
        .cta-button:hover { background-color: #44080f; }

        form { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        label { display: block; margin: 10px 0 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; font-size: 1em; }
        
        .password-container { position: relative; }
        .password-container i { position: absolute; right: 10px; top: 12px; cursor: pointer; color: #666; }

        .est-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 5px solid #5e0b15; }
        .est-card h3 { color: #5e0b15; margin-bottom: 5px; }
        .est-card p { margin-bottom: 5px; font-size: 0.95em; }
        .badge { background: #5e0b15; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; float: right; }

        footer { display: flex; justify-content: space-around; align-items: center; padding: 15px; background-color: #5e0b15; color: white; position: fixed; width: 100%; bottom: 0; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); }
        footer i { font-size: 1.4em; cursor: pointer; }

        .error { color: #d9534f; background: #f2dede; padding: 10px; border-radius: 4px; margin: 10px 0; display: none; }
        .success { color: #3c763d; background: #dff0d8; padding: 10px; border-radius: 4px; margin: 10px 0; display: none; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background: #5e0b15; color: white; }
    </style>
</head>
<body>

    <header>
        <div class="logo">Pasaporte del Vino</div>
        <div class="hamburger" onclick="toggleMenu()">&#9776;</div>
    </header>

    <div id="overlay" onclick="toggleMenu()"></div>

    <div id="menu">
        <div class="close" onclick="toggleMenu()">&times;</div>
        <ul>
            <li><a href="#" onclick="showPage('inicio')"><i class="fas fa-home"></i> Inicio</a></li>
            <li><a href="#" onclick="showPage('registrar')"><i class="fas fa-user-plus"></i> Nuevo Pasaporte</a></li>
            <li><a href="#" onclick="showPage('mipasaporte')"><i class="fas fa-id-card"></i> Mi Pasaporte</a></li>
            <li><a href="#" onclick="showPage('establecimientos')"><i class="fas fa-store"></i> Guía de Establecimientos</a></li>
            <li><hr></li>
            <li><a href="#" onclick="showPage('miestablecimiento')" style="color:#5e0b15; font-weight:bold;"><i class="fas fa-briefcase"></i> Mi Establecimiento</a></li>
            <li><a href="#" onclick="showPage('admin')"><i class="fas fa-cog"></i> Administración</a></li>
        </ul>
    </div>

    <main>
        <section id="inicio" class="page active">
            <h1>Pasaporte Turístico del Vino</h1>
            <h2>Vive el Enoturismo en Valladolid</h2>
            <p>El Pasaporte del Vino es tu llave para descubrir las mejores bodegas, museos y experiencias enológicas de la provincia. Colecciona sellos visitando nuestros establecimientos adheridos y obtén recompensas exclusivas.</p>
            
            <h3>¿Cómo funciona?</h3>
            <p style="margin-bottom: 5px;"><strong>1. Regístrate:</strong> Obtén tu código QR personal.</p>
            <p style="margin-bottom: 5px;"><strong>2. Visita:</strong> Acude a los establecimientos de la guía.</p>
            <p style="margin-bottom: 5px;"><strong>3. Sella:</strong> Muestra tu QR al personal para que sellen tu visita.</p>
            <p style="margin-bottom: 15px;"><strong>4. ¡Gana!:</strong> Al completar 4 sellos, recibirás un obsequio especial.</p>

            <button class="cta-button" onclick="showPage('registrar')">¡Empezar ahora!</button>
        </section>

        <section id="registrar" class="page">
            <h1>Nuevo Pasaporte</h1>
            <p>Introduce tus datos para generar tu pasaporte digital gratuito.</p>
            <form id="form-registro-turista">
                <label>Email:</label>
                <input type="email" id="tur-email" required>
                <label>Contraseña:</label>
                <div class="password-container">
                    <input type="password" id="tur-pass" required>
                    <i class="fas fa-eye" onclick="togglePass(this)"></i>
                </div>
                <label>Confirmar Contraseña:</label>
                <div class="password-container">
                    <input type="password" id="tur-pass-conf" required>
                    <i class="fas fa-eye" onclick="togglePass(this)"></i>
                </div>
                <div class="g-recaptcha" data-sitekey="6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI" style="margin: 15px 0;"></div>
                <button type="submit" class="cta-button">Crear mi Pasaporte</button>
            </form>
            <div id="msg-reg-turista"></div>
        </section>

        <section id="mipasaporte" class="page">
            <h1>Mi Pasaporte</h1>
            <div id="turista-auth">
                <form id="form-login-turista">
                    <h3>Acceso Turista</h3>
                    <label>Email:</label>
                    <input type="email" id="login-tur-email" required>
                    <label>Contraseña:</label>
                    <input type="password" id="login-tur-pass" required>
                    <button type="submit" class="cta-button">Entrar</button>
                </form>
            </div>
            <div id="turista-panel" style="display:none;">
                <div style="text-align:center; background:white; padding:20px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                    <h2 id="display-tur-email"></h2>
                    <div id="qrcode" style="display:flex; justify-content:center; margin:20px 0;"></div>
                    <p style="text-align:center; font-size:0.9em; color:#666;">Presenta este código en el establecimiento.</p>
                    <button class="cta-button" style="background:#777;" onclick="logout()">Cerrar Sesión</button>
                </div>
            </div>
        </section>

        <section id="establecimientos" class="page">
            <h1>Guía de Establecimientos</h1>
            <p>Estos son los lugares donde puedes obtener tus sellos:</p>
            <div id="lista-publica-est"></div>
        </section>

        <section id="miestablecimiento" class="page">
            <h1>Panel Profesional</h1>
            
            <div id="est-auth-options" style="text-align:center; margin-bottom:20px;">
                <button class="cta-button" onclick="showEstForm('login')">Ya soy socio (Login)</button>
                <button class="cta-button" style="background:#2c3e50;" onclick="showEstForm('registro')">Registrar mi Negocio</button>
            </div>

            <form id="form-registro-est" style="display:none;">
                <h3>Alta de Establecimiento</h3>
                <label>Email Profesional:</label>
                <input type="email" id="est-email" required>
                <label>Contraseña:</label>
                <input type="password" id="est-pass" required>
                <label>Confirmar Contraseña:</label>
                <input type="password" id="est-pass-conf" required>
                <hr style="margin:15px 0;">
                <label>Nombre del Establecimiento:</label>
                <input type="text" id="est-nombre" placeholder="Ej: Bodega Las Uvas" required>
                <label>Tipo de Establecimiento:</label>
                <select id="est-tipo">
                    <option value="Bodega">Bodega</option>
                    <option value="Restaurante">Restaurante</option>
                    <option value="Alojamiento">Alojamiento</option>
                    <option value="Vinoteca">Vinoteca</option>
                    <option value="Museo">Museo</option>
                </select>
                <label>Dirección:</label>
                <input type="text" id="est-dir" required>
                <label>Breve Descripción:</label>
                <textarea id="est-desc" rows="3"></textarea>
                <button type="submit" class="cta-button">Registrar y Acceder</button>
            </form>

            <form id="form-login-est" style="display:none;">
                <h3>Acceso Profesionales</h3>
                <label>Email:</label>
                <input type="email" id="login-est-email" required>
                <label>Contraseña:</label>
                <input type="password" id="login-est-pass" required>
                <button type="submit" class="cta-button">Acceder al Panel</button>
            </form>

            <div id="est-panel" style="display:none; text-align:center;">
                <div class="success" style="display:block;">Sesión iniciada: <strong id="display-est-nombre"></strong></div>
                <div style="margin-top:30px; padding:30px; border:3px dashed #5e0b15; border-radius:15px; background:white;">
                    <i class="fas fa-qrcode" style="font-size:3em; color:#5e0b15;"></i>
                    <h2>Sellar Pasaporte</h2>
                    <p>Usa esta opción cuando el cliente te muestre su código QR.</p>
                    <button class="cta-button" onclick="alert('Cámara (v0.12)')"><i class="fas fa-camera"></i> Escanear QR</button>
                </div>
                <button class="cta-button" style="background:#777; margin-top:20px;" onclick="logoutEst()">Cerrar Sesión Profesional</button>
            </div>
        </section>

        <section id="admin" class="page">
            <h1>Panel de Control</h1>
            <table id="table-admin">
                <thead>
                    <tr><th>Tipo</th><th>Nombre/Email</th></tr>
                </thead>
                <tbody></tbody>
            </table>
            <button class="cta-button" style="background:#c0392b; margin-top:30px;" onclick="resetDB()">BORRAR TODO (Reset)</button>
        </section>
    </main>

    <footer>
        <i class="fas fa-home" onclick="showPage('inicio')"></i>
        <i class="fas fa-id-card" onclick="showPage('mipasaporte')"></i>
        <i class="fas fa-store" onclick="showPage('establecimientos')"></i>
        <i class="fas fa-bars" onclick="toggleMenu()"></i>
    </footer>

    <script>
        // --- BASE DE DATOS Y ESTADO ---
        const db = {
            get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
            save: (key, data) => localStorage.setItem(key, JSON.stringify(data))
        };

        // --- NAVEGACIÓN ---
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            toggleMenu(false);
            if(id === 'establecimientos') renderEstablecimientos();
            if(id === 'admin') renderAdmin();
            if(id === 'mipasaporte') checkTuristaSesion();
            if(id === 'miestablecimiento') checkEstSesion();
        }

        function toggleMenu(force) {
            const menu = document.getElementById('menu');
            const overlay = document.getElementById('overlay');
            if (force === false) {
                menu.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                menu.classList.toggle('active');
                overlay.classList.toggle('active');
            }
        }

        function togglePass(icon) {
            const input = icon.parentElement.querySelector('input');
            input.type = input.type === 'password' ? 'text' : 'password';
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        }

        // --- LÓGICA TURISTAS ---
        document.getElementById('form-registro-turista').onsubmit = function(e) {
            e.preventDefault();
            const email = document.getElementById('tur-email').value;
            const pass = document.getElementById('tur-pass').value;
            const conf = document.getElementById('tur-pass-conf').value;

            if(pass !== conf) return alert("Las contraseñas no coinciden");

            let turistas = db.get('Pasaporte');
            if(turistas.find(t => t.email === email)) return alert("Email ya registrado");

            const nuevo = { id: Date.now(), email, pass };
            turistas.push(nuevo);
            db.save('Pasaporte', turistas);
            
            alert("¡Pasaporte creado con éxito! Ya puedes entrar en 'Mi Pasaporte'");
            showPage('mipasaporte');
        };

        document.getElementById('form-login-turista').onsubmit = function(e) {
            e.preventDefault();
            const email = document.getElementById('login-tur-email').value;
            const pass = document.getElementById('login-tur-pass').value;
            const u = db.get('Pasaporte').find(t => t.email === email && t.pass === pass);
            
            if(u) {
                localStorage.setItem('sesion_tur', JSON.stringify(u));
                checkTuristaSesion();
            } else alert("Credenciales incorrectas");
        };

        function checkTuristaSesion() {
            const s = JSON.parse(localStorage.getItem('sesion_tur'));
            const auth = document.getElementById('turista-auth');
            const panel = document.getElementById('turista-panel');
            if(s) {
                auth.style.display = 'none';
                panel.style.display = 'block';
                document.getElementById('display-tur-email').innerText = s.email;
                document.getElementById('qrcode').innerHTML = "";
                new QRCode(document.getElementById('qrcode'), { text: "ID:"+s.id, width: 200, height: 200 });
            } else {
                auth.style.display = 'block';
                panel.style.display = 'none';
            }
        }

        function logout() {
            localStorage.removeItem('sesion_tur');
            checkTuristaSesion();
        }

        // --- LÓGICA ESTABLECIMIENTOS ---
        function showEstForm(tipo) {
            document.getElementById('est-auth-options').style.display = 'none';
            document.getElementById('form-registro-est').style.display = tipo === 'registro' ? 'block' : 'none';
            document.getElementById('form-login-est').style.display = tipo === 'login' ? 'block' : 'none';
        }

        document.getElementById('form-registro-est').onsubmit = function(e) {
            e.preventDefault();
            const email = document.getElementById('est-email').value;
            const pass = document.getElementById('est-pass').value;
            const conf = document.getElementById('est-pass-conf').value;
            
            if(pass !== conf) return alert("Las contraseñas no coinciden");

            let ests = db.get('Establecimientos');
            if(ests.find(est => est.email === email)) return alert("Este email ya está en uso");

            const nuevo = {
                id: Date.now(),
                email, pass,
                nombre: document.getElementById('est-nombre').value,
                tipo: document.getElementById('est-tipo').value,
                direccion: document.getElementById('est-dir').value,
                desc: document.getElementById('est-desc').value
            };
            ests.push(nuevo);
            db.save('Establecimientos', ests);
            localStorage.setItem('sesion_est', JSON.stringify(nuevo));
            checkEstSesion();
        };

        document.getElementById('form-login-est').onsubmit = function(e) {
            e.preventDefault();
            const email = document.getElementById('login-est-email').value;
            const pass = document.getElementById('login-est-pass').value;
            const est = db.get('Establecimientos').find(x => x.email === email && x.pass === pass);
            
            if(est) {
                localStorage.setItem('sesion_est', JSON.stringify(est));
                checkEstSesion();
            } else alert("Error de acceso profesional");
        };

        function checkEstSesion() {
            const s = JSON.parse(localStorage.getItem('sesion_est'));
            const opts = document.getElementById('est-auth-options');
            const reg = document.getElementById('form-registro-est');
            const log = document.getElementById('form-login-est');
            const panel = document.getElementById('est-panel');
            
            if(s) {
                opts.style.display = 'none'; reg.style.display = 'none'; log.style.display = 'none';
                panel.style.display = 'block';
                document.getElementById('display-est-nombre').innerText = s.nombre;
            } else {
                opts.style.display = 'block'; panel.style.display = 'none';
            }
        }

        function logoutEst() {
            localStorage.removeItem('sesion_est');
            checkEstSesion();
        }

        // --- RENDERIZADO ---
        function renderEstablecimientos() {
            const lista = document.getElementById('lista-publica-est');
            lista.innerHTML = "";
            const datos = db.get('Establecimientos');
            if(datos.length === 0) lista.innerHTML = "<p>Aún no hay establecimientos registrados.</p>";
            datos.forEach(e => {
                lista.innerHTML += `
                    <div class="est-card">
                        <span class="badge">${e.tipo}</span>
                        <h3>${e.nombre}</h3>
                        <p><i class="fas fa-map-marker-alt"></i> ${e.direccion}</p>
                        <p style="font-size:0.85em; color:#666;">${e.desc}</p>
                    </div>
                `;
            });
        }

        function renderAdmin() {
            const body = document.querySelector('#table-admin tbody');
            body.innerHTML = "";
            db.get('Pasaporte').forEach(t => {
                body.innerHTML += `<tr><td>Turista</td><td>${t.email}</td></tr>`;
            });
            db.get('Establecimientos').forEach(e => {
                body.innerHTML += `<tr style="color:#5e0b15"><td>Tienda</td><td>${e.nombre} (${e.email})</td></tr>`;
            });
        }

        function resetDB() {
            if(confirm("¿Seguro que quieres borrar todos los datos?")) {
                localStorage.clear();
                location.reload();
            }
        }

        // Datos iniciales si está vacío
        if(db.get('Establecimientos').length === 0) {
            db.save('Establecimientos', [{id:1, nombre:'Bodega Demo', tipo:'Bodega', direccion:'Valladolid', email:'admin@test.com', pass:'123', desc:'Sitio de prueba'}]);
        }
    </script>
</body>
</html>
