<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pasaporte del Vino</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<style>
    /* --- ESTILOS GENERALES Y DE LA APP ORIGINAL --- */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { display: flex; flex-direction: column; height: 100vh; overflow: hidden; background-color: #f4f7fa; color: #333; }
    
    /* Variables para el Scanner (Integrado) */
    :root {
        --scanner-accent-green: #2ecc71;
        --scanner-success-color: #27ae60;
    }

    header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: #5e0b15; color: white; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); position: fixed; width: 100%; top: 0; z-index: 1000; }
    .logo { font-size: 1.5em; font-weight: bold; display: flex; align-items: center; gap: 8px; }
    .logo i { font-size: 1.8em; }
    .hamburger { cursor: pointer; font-size: 1.8em; }
    #menu { position: fixed; top: 0; right: -60%; width: 60%; height: 100%; background-color: #ffffff; box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2); transition: right 0.5s ease-in-out; z-index: 2000; padding: 60px 20px 20px; overflow-y: auto; }
    #menu.active { right: 0; }
    #menu .close { position: absolute; top: 15px; right: 20px; font-size: 1.8em; cursor: pointer; }
    #menu ul { list-style: none; }
    #menu li { margin: 15px 0; }
    #menu a { text-decoration: none; color: #333; font-size: 1.2em; display: block; padding: 10px; border-radius: 5px; transition: background 0.2s; }
    #menu a:hover { background-color: #e9ecef; }
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; z-index: 1500; }
    #overlay.active { display: block; }
    main { flex: 1; padding: 70px 20px 60px; overflow-y: auto; }
    .page { display: none; text-align: center; }
    .page.active { display: block; }
    .page h1 { margin-bottom: 20px; color: #5e0b15; font-size: 2em; font-weight: 700; }
    .page h2 { margin-top: 30px; color: #5e0b15; font-size: 1.5em; font-weight: 600; }
    .page ul, .page ol, .page p { text-align: left; margin: 15px auto; max-width: 800px; line-height: 1.6; }
    .page p { font-size: 1.1em; }
    .cta-button { background-color: #5e0b15; color: white; padding: 15px 30px; font-size: 1.5em; border: none; border-radius: 5px; cursor: pointer; margin: 20px auto; display: block; transition: background-color 0.2s; }
    .cta-button:hover { background-color: #480910; }
    form { max-width: 400px; margin: 0 auto; text-align: left; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    input[type="email"], input[type="password"], input[type="tel"], input[type="text"], textarea, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; }
    .password-container { position: relative; }
    .password-container input { padding-right: 40px; width: 100%; box-sizing: border-box; }
    .password-container i { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #999; }
    button[type="submit"] { background-color: #5e0b15; color: white; padding: 10px; width: 100%; border: none; border-radius: 5px; margin-top: 20px; cursor: pointer; }
    button[type="submit"]:hover { background-color: #480910; }
    #error-message, #login-error { color: red; margin-top: 10px; }
    #success-message { color: green; margin-top: 10px; font-weight: bold; }
    #qr-code { margin-top: 30px; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    #qr-code canvas, #qr-code img { border: 10px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    #context-menu { position: fixed; bottom: -50%; left: 0; width: 100%; height: 50%; background-color: #ffffff; box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.2); transition: bottom 0.5s ease-in-out; z-index: 2000; padding: 20px; overflow-y: auto; }
    #context-menu.active { bottom: 0; }
    #context-menu .close { position: absolute; top: 15px; right: 20px; font-size: 1.8em; cursor: pointer; }
    #context-menu ul { list-style: none; }
    #context-menu li { margin: 15px 0; }
    #context-menu a { text-decoration: none; color: #333; font-size: 1.2em; display: block; padding: 10px; border-radius: 5px; transition: background 0.2s; }
    #context-menu a:hover { background-color: #e9ecef; }
    footer { display: flex; justify-content: space-around; align-items: center; padding: 15px; background-color: #5e0b15; color: white; position: fixed; width: 100%; bottom: 0; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); z-index: 1000;}
    footer .icon { cursor: pointer; font-size: 1.5em; margin: 0 10px; transition: color 0.2s; }
    footer .icon:hover { color: #ffd700; }
    @media (max-width: 768px) {
        #menu { width: 80%; right: -80%; }
        #context-menu { height: 60%; bottom: -60%; }
    }
    @media (min-width: 1024px) { main { max-width: 800px; margin: 0 auto; } }
    .table-wrapper { margin-bottom: 40px; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; background-color: white; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); border-radius: 8px; overflow: hidden; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #5e0b15; color: white; }
    tr:hover { background-color: #f1f1f1; }
    .delete-all-btn { background-color: #ff0000; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
    .delete-all-btn:hover { background-color: #cc0000; }
    .logout-btn { background-color: #5e0b15; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; }
    .logout-btn:hover { background-color: #480910; }
    .hero-section { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
    .steps-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; text-align: center; }
    .step-card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-top: 4px solid #5e0b15; }
    .step-card i { font-size: 2em; color: #5e0b15; margin-bottom: 10px; display: block; }
    .step-card strong { display: block; margin-bottom: 5px; font-size: 1.1em; }
    .action-btn { background: none; border: none; cursor: pointer; font-size: 1.2em; margin-right: 10px; color: #5e0b15; }
    .action-btn:hover { color: #480910; }
    .establecimientos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    .est-card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.1); transition: transform 0.2s; display: flex; flex-direction: column; }
    .est-card:hover { transform: translateY(-5px); }
    .est-header { background-color: #5e0b15; color: white; padding: 15px; position: relative; }
    .est-type-badge { position: absolute; top: 10px; right: 10px; background-color: #ffd700; color: #5e0b15; padding: 4px 10px; border-radius: 20px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; }
    .est-body { padding: 15px; flex: 1; text-align: left; }
    .est-body h3 { margin-bottom: 10px; font-size: 1.2em; color: #333; }
    .est-body p { font-size: 0.9em; color: #666; margin-bottom: 8px; margin-left: 0; }
    .est-body i { width: 20px; color: #5e0b15; text-align: center; margin-right: 5px; }
    .est-footer { padding: 10px 15px; background-color: #f9f9f9; border-top: 1px solid #eee; font-size: 0.8em; color: #999; text-align: right; }
    .mi-establecimiento-form { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }
    .mi-establecimiento-form h2 { margin-bottom: 20px; color: #5e0b15; }
    
    /* Panel de control de establecimiento */
    .est-panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; }
    .est-controls { display: flex; justify-content: center; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
    .scan-btn { background-color: #3498db; color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .scan-btn:hover { background-color: #2980b9; }

    /* --- ESTILOS DEL ESCÁNER (OVERLAY) --- */
    #scanner-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
        display: none; /* Oculto por defecto */
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 5000; /* Muy por encima de todo */
    }

    #camera-window {
        position: relative;
        width: calc(100vw - 40px); /* 20px margen a cada lado */
        height: calc(100vw - 40px); /* Cuadrado */
        max-width: 500px;
        max-height: 500px;
        background-color: #000;
        overflow: hidden;
        border-radius: 12px;
        border: 2px solid #555;
        transition: border 0.3s ease;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    #camera-window.detected {
        border: 5px solid var(--scanner-accent-green) !important;
    }

    #camera-window canvas {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    #qr-result-label {
        color: white;
        margin-top: 20px;
        font-size: 1.1rem;
        min-height: 1.5em;
        padding: 0 20px;
        word-break: break-all;
        text-align: center;
    }

    /* Botón Redondo Sellar en medio de la cámara */
    #btn-sellar-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background-color: var(--scanner-success-color);
        color: white;
        border: 5px solid white;
        font-weight: bold;
        font-size: 1.2rem;
        cursor: pointer;
        display: none;
        box-shadow: 0 0 15px rgba(0,0,0,0.5);
        animation: popIn 0.3s ease-out;
        z-index: 10;
        text-align: center;
        line-height: 110px; /* Para centrar texto verticalmente */
    }

    @keyframes popIn {
        0% { transform: translate(-50%, -50%) scale(0); }
        80% { transform: translate(-50%, -50%) scale(1.1); }
        100% { transform: translate(-50%, -50%) scale(1); }
    }

    /* Mensaje de éxito del escáner */
    #scanner-success-msg {
        display: none;
        color: var(--scanner-success-color);
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        font-size: 1.3rem;
        max-width: 80%;
        text-align: center;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 5001;
    }

    .est-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
    .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
    .stat-value { font-size: 2em; font-weight: bold; color: #5e0b15; }
    .stat-label { font-size: 0.9em; color: #6c757d; }
    .sellos-received-list { max-height: 300px; overflow-y: auto; margin-top: 20px; }
    .premio-section { background: #d4edda; color: #155724; padding: 20px; border-radius: 8px; margin: 20px auto; max-width: 600px; }
    .admin-login-form { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
    .admin-login-form h2 { margin-bottom: 20px; color: #5e0b15; }
    #search-container { position: sticky; bottom: 60px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 -2px 8px rgba(0,0,0,0.1); z-index: 100; margin-top: 20px; display: flex; align-items: center; }
    #search-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; margin-right: 10px; }
    #search-icon { color: #5e0b15; font-size: 1.2em; }
    .stats-overview { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
    .stat-item { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; }
    .stat-number { font-size: 2.5em; font-weight: bold; color: #5e0b15; }
    .stat-title { font-size: 1em; color: #6c757d; margin-top: 5px; }
    .simulated-recaptcha { margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; display: flex; align-items: center; }
    .simulated-recaptcha input { margin-right: 10px; }
    .simulated-recaptcha label { cursor: pointer; }
</style>
</head>
<body>
<header>
<div class="logo"><i class="fas fa-wine-bottle"></i> Pasaporte del Vino</div>
<div class="hamburger">&#9776;</div>
</header>
<div id="menu">
<div class="close">&times;</div>
<ul>
<li><a href="?page=registrar">Registrar pasaporte</a></li>
<li><a href="?page=mipasaporte">Mi pasaporte</a></li>
<li><a href="?page=establecimientos">Establecimientos</a></li>
<li><a href="?page=miestablecimiento">Mi Establecimiento</a></li>
<li><a href="?page=admin">Admin</a></li>
</ul>
</div>
<div id="overlay"></div>
<main>
<section id="inicio" class="page">
<h1>Pasaporte Turístico del Vino</h1>
<div class="hero-section">
<p>Descubre el enoturismo como nunca antes. Vive experiencias únicas, colecciona sellos en tu <strong>PASAPORTE TURÍSTICO DEL VINO</strong> y consigue premios exclusivos.</p>
<button class="cta-button" onclick="navigateTo('registrar')">Obtener Pasaporte</button>
</div>
<h2>¿Cómo funciona?</h2>
<div class="steps-grid">
<div class="step-card">
<i class="fas fa-file-download"></i>
<strong>1. Consíguelo</strong>
<p>Regístrate en la app para obtener tu código QR.</p>
</div>
<div class="step-card">
<i class="fas fa-wine-glass"></i>
<strong>2. Visita</strong>
<p>Acude a los establecimientos adheridos y disfruta de la experiencia.</p>
</div>
<div class="step-card">
<i class="fas fa-camera"></i>
<strong>3. Sella</strong>
<p>Muestra tu pasaporte y consigue al menos 4 sellos diferentes.</p>
</div>
<div class="step-card">
<i class="fas fa-gift"></i>
<strong>4. Gana</strong>
<p>Recibe un lote de productos "Alimentos de Valladolid" GRATIS.</p>
</div>
</div>
<h2>Premios y Sorteos</h2>
<p>Con todas las hojas de sellado del Pasaporte turístico del Vino recibidos antes del <strong>30 de diciembre de 2025</strong>, se sortearán 4 experiencias de enoturismo, para dos personas, en las Rutas del Vino de la Provincia de Valladolid.</p>
<h2>Términos y condiciones resumidos</h2>
<p>Participan mayores de edad. Se validará que los sellos sean de diferentes establecimientos. Fecha límite de campaña: 30 de diciembre de 2025. Sorteo en enero de 2026.</p>
<button class="cta-button" onclick="navigateTo('registrar')">Crear mi Pasaporte Ahora</button>
<button class="cta-button" style="background-color: #2c3e50; margin-top: 10px;" onclick="navigateTo('registrar')">¡Empieza tu aventura enoturística!</button>
<div style="margin-top: 40px; font-size: 0.9em; color: #666;">
<h3 style="color: #666; font-size: 1.1em; margin-bottom: 10px;">Privacidad</h3>
<p>Sus datos serán tratados por la Diputación Provincial de Valladolid para la promoción de actividades turísticas. Puede ejercer sus derechos contactando a dpd@dipvalladolid.es.</p>
</div>
</section>
<section id="registrar" class="page">
<h1>Registrar pasaporte</h1>
<div id="registration-container">
<form id="register-form">
<label for="email">Email:</label>
<input type="email" id="email" required>
<label for="password">Contraseña:</label>
<div class="password-container">
<input type="password" id="password" required>
<i class="fas fa-eye" id="toggle-password"></i>
</div>
<label for="confirm-password">Confirmar Contraseña:</label>
<div class="password-container">
<input type="password" id="confirm-password" required>
<i class="fas fa-eye" id="toggle-confirm-password"></i>
</div>
<label for="tlf">Teléfono (opcional):</label>
<input type="tel" id="tlf">
<div class="simulated-recaptcha">
<input type="checkbox" id="recaptcha-registrar" required>
<label for="recaptcha-registrar">No soy un robot</label>
</div>
<button type="submit">Crear Pasaporte</button>
</form>
</div>
<div id="error-message"></div>
<div id="success-message"></div>
<div id="qr-code"></div>
<div id="post-register-actions" style="display:none; margin-top: 20px;">
<button class="cta-button" onclick="navigateTo('mipasaporte')">Ir a Mi Pasaporte</button>
</div>
</section>
<section id="mipasaporte" class="page">
<h1>Mi pasaporte</h1>
<form id="login-form" style="display: block;">
<label for="login-email">Email:</label>
<input type="email" id="login-email" required>
<label for="login-password">Contraseña:</label>
<div class="password-container">
<input type="password" id="login-password" required>
<i class="fas fa-eye" id="toggle-login-password"></i>
</div>
<div class="simulated-recaptcha">
<input type="checkbox" id="recaptcha-login" required>
<label for="recaptcha-login">No soy un robot</label>
</div>
<button type="submit">Iniciar Sesión</button>
</form>
<div id="login-error"></div>
<div id="pasaporte-info" style="display: none;">
<p id="pasaporte-email"></p>
<p id="pasaporte-fecha-expedicion"></p>
<p id="pasaporte-sellos"></p>
<div id="premio-section" style="display: none;"></div>
<div id="pasaporte-qr" style="display: flex; justify-content: center; margin-top: 20px;"></div>
<button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
</div>
</section>
<section id="establecimientos" class="page">
<h1>Nuestros Establecimientos</h1>
<div class="establecimientos-grid" id="establecimientos-list"></div>
<div id="search-container">
<input type="text" id="search-input" placeholder="Buscar establecimiento...">
<i class="fas fa-search" id="search-icon"></i>
</div>
</section>
<section id="miestablecimiento" class="page">
<h1>Mi Establecimiento</h1>
<div id="mi-establecimiento-form-container" class="mi-establecimiento-form">
<form id="mi-establecimiento-login-form">
<label for="mi-est-nombre">Nombre del Establecimiento:</label>
<input type="text" id="mi-est-nombre" required placeholder="Ej. Bodegas Familiares">
<label for="mi-est-password">Contraseña:</label>
<div class="password-container">
<input type="password" id="mi-est-password" required>
<i class="fas fa-eye" id="toggle-mi-est-password"></i>
</div>
<div class="simulated-recaptcha">
<input type="checkbox" id="recaptcha-est-login" required>
<label for="recaptcha-est-login">No soy un robot</label>
</div>
<button type="submit">Iniciar Sesión</button>
</form>
</div>
<div id="mi-establecimiento-panel" style="display: none; margin-top: 30px;">
<div class="est-panel">
<div id="est-info">
<h2>Bienvenido, <span id="est-nombre-display"></span></h2>
<div class="est-controls">
    <button class="scan-btn" onclick="startScanningOverlay()"><i class="fas fa-qrcode"></i> Escanear QR</button>
    <button class="logout-btn" onclick="logoutEstablecimiento()" style="margin-top:0;">Cerrar Sesión</button>
</div>
<div class="est-stats">
<div class="stat-card">
<div class="stat-value" id="sellos-count">0</div>
<div class="stat-label">Sellos Recibidos</div>
</div>
<div class="stat-card">
<div class="stat-value" id="visitas-count">0</div>
<div class="stat-label">Visitantes Diferentes</div>
</div>
</div>
</div>
<h3>Sellos Recibidos Recientes</h3>
<div class="sellos-received-list" id="sellos-list"></div>
</div>
</div>
</section>
<section id="admin-login" class="page">
<h1>Acceso Administrador</h1>
<div class="admin-login-form">
<form id="admin-login-form">
<label for="admin-email">Email:</label>
<input type="email" id="admin-email" value="admin@admin.com" required>
<label for="admin-password">Contraseña:</label>
<div class="password-container">
<input type="password" id="admin-password" value="admin" required>
<i class="fas fa-eye" id="toggle-admin-password"></i>
</div>
<div class="simulated-recaptcha">
<input type="checkbox" id="recaptcha-admin" required>
<label for="recaptcha-admin">No soy un robot</label>
</div>
<button type="submit">Acceder</button>
</form>
</div>
<div id="admin-login-error" style="color: red; margin-top: 10px;"></div>
</section>
<section id="admin" class="page">
<h1>Panel de Administración</h1>
<div class="table-wrapper">
<h2>Pasaportes</h2>
<button class="delete-all-btn" onclick="clearTable('Pasaporte')">Borrar todos los pasaportes</button>
<table id="pasaporte-table">
<thead>
<tr><th>Acciones</th><th>ID</th><th>Email</th><th>Sellos</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="table-wrapper">
<h2>Establecimientos</h2>
<button class="delete-all-btn" onclick="clearTable('Establecimiento')">Borrar todos los establecimientos</button>
<table id="establecimiento-table">
<thead>
<tr><th>Acciones</th><th>ID</th><th>Nombre</th><th>Tipo</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="table-wrapper">
<h2>Sellos</h2>
<button class="delete-all-btn" onclick="clearTable('Sello')">Borrar todos los sellos</button>
<table id="sello-table">
<thead>
<tr><th>ID</th><th>ID Pasaporte</th><th>ID Establecimiento</th><th>Fecha</th><th>Activo</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
</section>
<section id="estadisticas" class="page">
<h1>Estadísticas de la Aplicación</h1>
<div class="stats-overview">
<div class="stats-grid">
<div class="stat-item">
<div class="stat-number" id="total-pasaportes">0</div>
<div class="stat-title">Pasaportes Registrados</div>
</div>
<div class="stat-item">
<div class="stat-number" id="total-establecimientos">0</div>
<div class="stat-title">Establecimientos Adheridos</div>
</div>
<div class="stat-item">
<div class="stat-number" id="total-sellos">0</div>
<div class="stat-title">Sellos Emitidos</div>
</div>
<div class="stat-item">
<div class="stat-number" id="pasaportes-completos">0</div>
<div class="stat-title">Pasaportes Completos (4+ sellos)</div>
</div>
</div>
</div>
</section>
<section id="altaestablecimiento" class="page">
<h1>Alta de Establecimiento</h1>
<div class="mi-establecimiento-form">
<form id="alta-establecimiento-form">
<label for="alta-nombre">Nombre del Establecimiento:</label>
<input type="text" id="alta-nombre" required placeholder="Ej. Bodegas Familiares">
<label for="alta-tipo">Tipo:</label>
<select id="alta-tipo" required>
<option value="Bodega">Bodega</option>
<option value="Restaurante">Restaurante</option>
<option value="Museo">Museo</option>
<option value="Alojamiento">Alojamiento</option>
<option value="Vinoteca">Vinoteca</option>
</select>
<label for="alta-direccion">Dirección:</label>
<input type="text" id="alta-direccion" required placeholder="Calle, Localidad...">
<label for="alta-descripcion">Descripción Corta:</label>
<textarea id="alta-descripcion" rows="3" required placeholder="Breve descripción de la experiencia..."></textarea>
<label for="alta-password">Contraseña:</label>
<div class="password-container">
<input type="password" id="alta-password" required>
<i class="fas fa-eye" id="toggle-alta-password"></i>
</div>
<label for="alta-confirm-password">Confirmar Contraseña:</label>
<div class="password-container">
<input type="password" id="alta-confirm-password" required>
<i class="fas fa-eye" id="toggle-alta-confirm-password"></i>
</div>
<div class="simulated-recaptcha">
<input type="checkbox" id="recaptcha-alta" required>
<label for="recaptcha-alta">No soy un robot</label>
</div>
<button type="submit">Registrar Establecimiento</button>
</form>
</div>
</section>
</main>

<div id="scanner-overlay">
    <h1>Scan QR</h1>
    <div id="camera-window">
        <canvas id="scanner-canvas"></canvas>
        <button id="btn-sellar-overlay" onclick="sellarDesdeScanner()">Sellar</button>
    </div>
    <div id="qr-result-label">Buscando código QR...</div>
    <button onclick="stopScanningOverlay()" style="margin-top: 20px; background: transparent; border: 1px solid white; color: white; padding: 10px 20px; border-radius: 4px; cursor:pointer;">Cancelar</button>
</div>

<div id="scanner-success-msg">
    <div style="font-size: 3rem; margin-bottom: 10px;">✅</div>
    Su pasaporte ha sido sellado con éxito
</div>

<footer>
<span class="icon home" title="Inicio" onclick="navigateTo('inicio')"><i class="fas fa-house"></i></span>
<span>2026-v0.11.11</span>
<span class="icon options" title="Opciones" onclick="toggleContextMenu()"><i class="fas fa-ellipsis-v"></i></span>
</footer>
<div id="context-menu">
<div class="close" onclick="toggleContextMenu()">&times;</div>
<ul id="context-items"></ul>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- VARIABLES ESCÁNER ---
    const scannerVideo = document.createElement("video");
    const scannerCanvasElement = document.getElementById("scanner-canvas");
    const scannerCanvas = scannerCanvasElement.getContext("2d", { willReadFrequently: true });
    const scannerOverlay = document.getElementById("scanner-overlay");
    const cameraWindow = document.getElementById("camera-window");
    const resultLabel = document.getElementById("qr-result-label");
    const btnSellarOverlay = document.getElementById("btn-sellar-overlay");
    const scannerSuccessMsg = document.getElementById("scanner-success-msg");

    let scanning = false;
    let localStream = null;
    let currentQRData = null; // Guardar el dato detectado

    const hamburger = document.querySelector('.hamburger');
    const menu = document.getElementById('menu');
    const closeMenuBtn = menu.querySelector('.close');
    const overlay = document.getElementById('overlay');
    const pages = document.querySelectorAll('.page');
    const contextMenu = document.getElementById('context-menu');
    const contextItems = document.getElementById('context-items');

    function toggleMenu() {
        menu.classList.toggle('active');
        overlay.classList.toggle('active');
    }

    hamburger.addEventListener('click', toggleMenu);
    closeMenuBtn.addEventListener('click', toggleMenu);

    // --- CORRECCIÓN PUNTO 4: GESTIÓN DE OVERLAY INDEPENDIENTE ---
    overlay.addEventListener('click', () => {
        if (contextMenu.classList.contains('active')) {
            toggleContextMenu();
        } else if (menu.classList.contains('active')) {
            toggleMenu();
        }
    });

    window.toggleContextMenu = function() {
        contextMenu.classList.toggle('active');
        overlay.classList.toggle('active');
        loadContextItems();
    };

    function loadContextItems() {
        contextItems.innerHTML = '';
        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get('page') || 'inicio';
        let items = [];
        if (page === 'admin') {
            items = ['Estadísticas', 'Alta Establecimiento', 'Exportar DB', 'Importar DB', 'Borrar DB', 'Configuración', 'Ayuda'];
        } else {
            items = ['Configuración', 'Ayuda'];
        }
        items.forEach(item => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.textContent = item;
            a.href = '#';
            a.onclick = (e) => {
                e.preventDefault();
                if (item === 'Alta Establecimiento') {
                    navigateTo('altaestablecimiento');
                } else if (item === 'Exportar DB') {
                    exportDB();
                } else if (item === 'Importar DB') {
                    importDB();
                } else if (item === 'Estadísticas') {
                    navigateTo('estadisticas');
                } else if (item === 'Borrar DB') {
                    // --- PUNTO 3: LÓGICA DE BORRADO Y SEED ---
                    if (confirm("¿Está seguro de que desea resetear toda la base de datos?")) {
                        localStorage.clear();
                        initDB(); // Ejecuta seedData() internamente si está vacío
                        alert("Base de datos reseteada con éxito.");
                        location.reload();
                    }
                }
                toggleContextMenu();
            };
            li.appendChild(a);
            contextItems.appendChild(li);
        });
    }

    window.navigateTo = function(page) {
        history.pushState(null, '', `?page=${page}`);
        loadPage();
    };

    function loadPage() {
        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get('page') || 'inicio';
        pages.forEach(p => p.classList.remove('active'));
        const activePage = document.getElementById(page);
        if (activePage) {
            activePage.classList.add('active');
        } else if (page === 'inicio') {
            document.getElementById('inicio').classList.add('active');
        }
        if (page === 'mipasaporte') loadPasaporteInfo();
        if (page === 'admin') {
            if (localStorage.getItem('isAdminLoggedIn') === 'true') {
                loadAdminData();
            } else {
                navigateTo('admin-login');
            }
        }
        if (page === 'establecimientos') {
            renderEstablecimientos();
            document.getElementById('search-input').value = '';
        }
        if (page === 'registrar') {
            const form = document.getElementById('register-form');
            form.reset();
            form.style.display = 'block';
            document.getElementById('post-register-actions').style.display = 'none';
            document.getElementById('success-message').textContent = '';
            document.getElementById('error-message').textContent = '';
            document.getElementById('qr-code').innerHTML = '';
        }
        if (page === 'miestablecimiento') {
            const idEst = localStorage.getItem('currentEstablecimientoId');
            const loginFormContainer = document.getElementById('mi-establecimiento-form-container');
            const panel = document.getElementById('mi-establecimiento-panel');
            
            if (idEst) {
                // Ya logueado
                loginFormContainer.style.display = 'none';
                panel.style.display = 'block';
                loadEstablecimientoPanel();
            } else {
                // No logueado
                loginFormContainer.style.display = 'block';
                document.getElementById('mi-establecimiento-login-form').reset();
                panel.style.display = 'none';
            }
        }
        if (page === 'estadisticas') loadEstadisticas();
    }

    window.addEventListener('popstate', loadPage);
    loadPage();

    menu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const href = new URL(link.href);
            navigateTo(href.searchParams.get('page'));
            toggleMenu();
        });
    });

    // Database functions
    function initDB() {
        const tables = ['Pasaporte', 'Establecimiento', 'Sello'];
        tables.forEach(t => {
            if (!localStorage.getItem(t)) {
                localStorage.setItem(t, JSON.stringify([]));
            }
        });
        const ps = JSON.parse(localStorage.getItem('Pasaporte'));
        if (ps.length === 0) seedData();
    }

    function seedData() {
        let pasaportes = [];
        for(let i=1; i<=5; i++) {
            pasaportes.push({
                id_pasaporte: i,
                email: `p${i}@p.com`,
                password: '.',
                tlf: `60000000${i}`,
                fecha_expedicion: new Date().toISOString(),
                fecha_expiracion: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString(),
                activo: 1
            });
        }
        localStorage.setItem('Pasaporte', JSON.stringify(pasaportes));
        let establecimientos = [];
        const tipos = ["Bodega", "Restaurante", "Museo", "Alojamiento", "Vinoteca"];
        for(let i=1; i<=20; i++) {
            const tipo = tipos[(i-1) % tipos.length];
            const nombre = `Establecimiento${i}@e.com`;
            establecimientos.push({
                id_establecimiento: i,
                nombre,
                tipo,
                direccion: `Calle ${i}, Localidad`,
                descripcion: `Descripción del ${nombre}`,
                password: '.',
                email: `info@${nombre}.com`,
                fecha_alta: new Date(Date.now() - Math.floor(Math.random() * 1000000000)).toISOString()
            });
        }
        localStorage.setItem('Establecimiento', JSON.stringify(establecimientos));
        
        // --- SEED DE SELLOS: 3 sellos sobre el ID=1 ---
        let sellos = [];
        for(let i=1; i<=3; i++) {
            sellos.push({
                id_sello: i,
                id_pasaporte: 1,
                id_establecimiento: i,
                fecha: new Date().toISOString(),
                activo: 1
            });
        }
        localStorage.setItem('Sello', JSON.stringify(sellos));
    }

    const getTable = (t) => JSON.parse(localStorage.getItem(t) || '[]');
    const saveTable = (t, d) => localStorage.setItem(t, JSON.stringify(d));

    window.db = {
        getTable,
        addPasaporte: (data) => {
            let ps = getTable('Pasaporte');
            const id = ps.length > 0 ? Math.max(...ps.map(p => p.id_pasaporte)) + 1 : 1;
            const n = { id_pasaporte: id, ...data, fecha_expedicion: new Date().toISOString(),
            fecha_expiracion: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString(), activo: 1 };
            ps.push(n); saveTable('Pasaporte', ps); return n;
        },
        getPasaporte: (id) => getTable('Pasaporte').find(p => p.id_pasaporte === id),
        getPasaporteByEmail: (e) => getTable('Pasaporte').find(p => p.email === e && p.activo === 1),
        getSellosByPasaporte: (id) => getTable('Sello').filter(s => s.id_pasaporte === id && s.activo === 1),
        addEstablecimiento: (data) => {
            let ests = getTable('Establecimiento');
            const id = ests.length > 0 ? Math.max(...ests.map(e => e.id_establecimiento)) + 1 : 1;
            const n = { id_establecimiento: id, ...data, fecha_alta: new Date().toISOString() };
            ests.push(n); saveTable('Establecimiento', ests); return n;
        },
        getEstablecimiento: (id) => getTable('Establecimiento').find(e => e.id_establecimiento === id),
        getEstablecimientoByNombre: (n) => getTable('Establecimiento').find(e => e.nombre === n),
        addSello: (data) => {
            let ss = getTable('Sello');
            const id = ss.length > 0 ? Math.max(...ss.map(s => s.id_sello)) + 1 : 1;
            const n = { id_sello: id, ...data, fecha: new Date().toISOString(), activo: 1 };
            ss.push(n); saveTable('Sello', ss); return n;
        },
        getSellosByEstablecimiento: (id) => getTable('Sello').filter(s => s.id_establecimiento === id && s.activo === 1),
        getSellosByPasaporteAndEstablecimiento: (pid, eid) => getTable('Sello').find(s => s.id_pasaporte === pid && s.id_establecimiento === eid && s.activo === 1)
    };

    initDB();

    // Registro de pasaporte
    const registerForm = document.getElementById('register-form');
    registerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const err = document.getElementById('error-message');
        const succ = document.getElementById('success-message');
        const qrDiv = document.getElementById('qr-code');
        err.textContent = ''; succ.textContent = ''; qrDiv.innerHTML = '';

        if (!document.getElementById('recaptcha-registrar').checked) {
            err.textContent = 'Completa la verificación.';
            return;
        }

        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        if (password !== document.getElementById('confirm-password').value) {
            err.textContent = 'Las contraseñas no coinciden.';
            return;
        }
        if (db.getTable('Pasaporte').some(p => p.email === email && p.activo === 1)) {
            err.textContent = 'El email ya existe.';
            return;
        }

        const newP = db.addPasaporte({ email, password, tlf: document.getElementById('tlf').value });
        registerForm.style.display = 'none';
        succ.textContent = '¡Pasaporte creado con éxito!';
        const qrUrl = `airooc41n.github.io/miapp?email=${encodeURIComponent(email)}&Id=${newP.id_pasaporte}`;
        new QRCode(qrDiv, { text: qrUrl, width: 300, height: 300 });
        localStorage.setItem('currentPasaporteId', newP.id_pasaporte);
        document.getElementById('post-register-actions').style.display = 'block';
    });

    // Login pasaporte
    const loginForm = document.getElementById('login-form');
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();

        if (!document.getElementById('recaptcha-login').checked) {
            document.getElementById('login-error').textContent = 'Completa la verificación.';
            return;
        }

        const email = document.getElementById('login-email').value.trim();
        const pass = document.getElementById('login-password').value;
        const p = db.getPasaporteByEmail(email);
        if (!p || p.password !== pass) {
            document.getElementById('login-error').textContent = 'Error de credenciales.';
            return;
        }
        localStorage.setItem('currentPasaporteId', p.id_pasaporte);
        loadPasaporteInfo();
    });

    function loadPasaporteInfo() {
        const id = parseInt(localStorage.getItem('currentPasaporteId'));
        const info = document.getElementById('pasaporte-info');
        const loginF = document.getElementById('login-form');
        const premioSection = document.getElementById('premio-section');

        if (!id) {
            loginF.style.display = 'block';
            info.style.display = 'none';
            return;
        }

        const p = db.getPasaporte(id);
        if (!p) {
            logout();
            return;
        }

        loginF.style.display = 'none';
        info.style.display = 'block';
        document.getElementById('pasaporte-email').textContent = `Email: ${p.email}`;
        document.getElementById('pasaporte-fecha-expedicion').textContent = `Expedido: ${new Date(p.fecha_expedicion).toLocaleDateString()}`;
        const sellos = db.getSellosByPasaporte(id);
        const sellosCount = sellos.length;
        document.getElementById('pasaporte-sellos').textContent = `Sellos: ${sellosCount}`;

        const estIds = [...new Set(sellos.map(s => s.id_establecimiento))];
        const estDistintos = estIds.length;
        if (estDistintos >= 4) {
            premioSection.style.display = 'block';
            premioSection.innerHTML = '<div class="premio-section"><h3>¡Enhorabuena! Has conseguido 4 sellos diferentes.</h3><p>Puedes reclamar tu premio de productos "Alimentos de Valladolid".</p></div>';
        } else {
            premioSection.style.display = 'none';
        }

        const qrCont = document.getElementById('pasaporte-qr');
        qrCont.innerHTML = '';
        const qrUrl = `airooc41n.github.io/miapp?email=${encodeURIComponent(p.email)}&Id=${p.id_pasaporte}`;
        new QRCode(qrCont, { text: qrUrl, width: 250, height: 250 });
    }

    window.logout = () => {
        localStorage.removeItem('currentPasaporteId');
        loadPasaporteInfo();
    };

    window.verPasaporte = (id) => {
        localStorage.setItem('currentPasaporteId', id);
        navigateTo('mipasaporte');
    };

    // Establecimientos con buscador
    window.renderEstablecimientos = () => {
        const list = document.getElementById('establecimientos-list');
        list.innerHTML = '';
        let ests = db.getTable('Establecimiento');
        ests.sort((a, b) => new Date(b.fecha_alta) - new Date(a.fecha_alta));

        ests.forEach(est => {
            const card = document.createElement('div');
            card.className = 'est-card';
            let iconClass = 'fa-building';
            if(est.tipo === 'Bodega') iconClass = 'fa-wine-bottle';
            if(est.tipo === 'Restaurante') iconClass = 'fa-utensils';
            if(est.tipo === 'Museo') iconClass = 'fa-landmark';
            if(est.tipo === 'Alojamiento') iconClass = 'fa-bed';
            if(est.tipo === 'Vinoteca') iconClass = 'fa-glass-cheers';

            card.innerHTML = `
            <div class="est-header">
                <i class="fas ${iconClass}" style="font-size: 2em; opacity: 0.8;"></i>
                <span class="est-type-badge">${est.tipo}</span>
            </div>
            <div class="est-body">
                <h3>${est.nombre}</h3>
                <p><i class="fas fa-map-marker-alt"></i> ${est.direccion}</p>
                <p>${est.descripcion}</p>
            </div>
            <div class="est-footer">
                Alta: ${new Date(est.fecha_alta).toLocaleDateString()}
            </div>
            `;
            card.dataset.nombre = est.nombre.toLowerCase();
            card.dataset.tipo = est.tipo.toLowerCase();
            card.dataset.direccion = est.direccion.toLowerCase();
            list.appendChild(card);
        });
    };

    window.filterEstablecimientos = () => {
        const query = document.getElementById('search-input').value.toLowerCase().trim();
        const cards = document.querySelectorAll('.est-card');
        cards.forEach(card => {
            const nombre = card.dataset.nombre || '';
            const tipo = card.dataset.tipo || '';
            const direccion = card.dataset.direccion || '';
            const match = nombre.includes(query) || tipo.includes(query) || direccion.includes(query);
            card.style.display = match ? 'flex' : 'none';
        });
    };

    // --- CORRECCIÓN PUNTO 2: LOGIN ESTABLECIMIENTO ---
    const miEstLoginForm = document.getElementById('mi-establecimiento-login-form');
    if (miEstLoginForm) {
        miEstLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();

            if (!document.getElementById('recaptcha-est-login').checked) {
                alert('Completa la verificación.');
                return;
            }

            const nombre = document.getElementById('mi-est-nombre').value.trim();
            const password = document.getElementById('mi-est-password').value;
            const est = db.getEstablecimientoByNombre(nombre);
            if (!est || est.password !== password) {
                alert('Credenciales incorrectas.');
                return;
            }
            localStorage.setItem('currentEstablecimientoId', est.id_establecimiento);
            
            // Ocultar formulario de login (Punto 2) y mostrar panel
            document.getElementById('mi-establecimiento-form-container').style.display = 'none';
            document.getElementById('mi-establecimiento-panel').style.display = 'block';
            loadEstablecimientoPanel();
        });
    }

    // --- NUEVA LÓGICA DE ESCANEO (OVERLAY) ---
    window.startScanningOverlay = function() {
        // UI Reset
        scannerOverlay.style.display = "flex";
        btnSellarOverlay.style.display = "none";
        cameraWindow.classList.remove("detected");
        resultLabel.innerText = "Buscando código QR...";
        scannerSuccessMsg.style.display = 'none';
        
        scanning = true;

        // Solicitar acceso a la cámara (preferiblemente trasera)
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(function(stream) {
                localStream = stream;
                scannerVideo.srcObject = stream;
                scannerVideo.setAttribute("playsinline", true); // Requerido para iOS
                scannerVideo.play();
                requestAnimationFrame(tickOverlay);
            })
            .catch(function(err) {
                console.error("Error al acceder a la cámara", err);
                alert("No se pudo acceder a la cámara. Asegúrate de estar en HTTPS y dar permisos.");
                stopScanningOverlay();
            });
    }

    function tickOverlay() {
        if (!scanning) return;

        if (scannerVideo.readyState === scannerVideo.HAVE_ENOUGH_DATA) {
            scannerCanvasElement.height = scannerVideo.videoHeight;
            scannerCanvasElement.width = scannerVideo.videoWidth;
            
            scannerCanvas.drawImage(scannerVideo, 0, 0, scannerCanvasElement.width, scannerCanvasElement.height);
            
            var imageData = scannerCanvas.getImageData(0, 0, scannerCanvasElement.width, scannerCanvasElement.height);
            var code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            if (code) {
                // QR Detectado
                drawQuadOverlay(code.location.topLeftCorner, code.location.topRightCorner, code.location.bottomRightCorner, code.location.bottomLeftCorner, "#00FF00");

                if (!cameraWindow.classList.contains("detected")) {
                    cameraWindow.classList.add("detected");
                }
                
                // Mostrar datos y botón
                resultLabel.innerText = "Detectado: " + code.data;
                currentQRData = code.data;

                if (btnSellarOverlay.style.display !== "block") {
                    btnSellarOverlay.style.display = "block";
                    if (window.navigator && window.navigator.vibrate) {
                        window.navigator.vibrate(200);
                    }
                }
            } else {
                // No QR - Opcional: limpiar UI si se pierde el QR
            }
        }
        requestAnimationFrame(tickOverlay);
    }

    function drawLineOverlay(begin, end, color) {
        scannerCanvas.beginPath();
        scannerCanvas.moveTo(begin.x, begin.y);
        scannerCanvas.lineTo(end.x, end.y);
        scannerCanvas.lineWidth = 4;
        scannerCanvas.strokeStyle = color;
        scannerCanvas.stroke();
    }

    function drawQuadOverlay(tl, tr, br, bl, color) {
        drawLineOverlay(tl, tr, color);
        drawLineOverlay(tr, br, color);
        drawLineOverlay(br, bl, color);
        drawLineOverlay(bl, tl, color);
    }

    window.stopScanningOverlay = function() {
        scanning = false;
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
        }
        scannerOverlay.style.display = "none";
    }

    window.sellarDesdeScanner = function() {
        if (!currentQRData) return;

        // Parsear datos del QR
        const urlParams = new URLSearchParams(currentQRData);
        let idPasaporte = urlParams.get('Id');
        
        if (!idPasaporte && currentQRData.includes('Id=')) {
            const parts = currentQRData.split('Id=');
            if (parts.length > 1) {
                idPasaporte = parts[1].split('&')[0];
            }
        }

        if (!idPasaporte) {
            alert('QR no válido para esta aplicación.');
            return;
        }

        const currentEstId = parseInt(localStorage.getItem('currentEstablecimientoId'));
        if (!currentEstId) {
            alert('Error de sesión. Vuelva a loguearse.');
            stopScanningOverlay();
            return;
        }

        const pasaporte = db.getPasaporte(parseInt(idPasaporte));
        if (!pasaporte) {
            alert('El pasaporte escaneado no existe en la base de datos.');
            return;
        }

        if (db.getSellosByPasaporteAndEstablecimiento(parseInt(idPasaporte), currentEstId)) {
            alert('Este pasaporte ya tiene un sello de este establecimiento.');
            return;
        }

        // --- ÉXITO: GUARDAR SELLO ---
        db.addSello({
            id_pasaporte: parseInt(idPasaporte),
            id_establecimiento: currentEstId
        });

        // 1. Detener escaneo
        scanning = false;
        if (localStream) localStream.getTracks().forEach(track => track.stop());
        scannerOverlay.style.display = "none";

        // 2. Mostrar mensaje de éxito bonito
        scannerSuccessMsg.style.display = 'block';
        
        // 3. Recargar panel tras 2 segundos
        setTimeout(() => {
            scannerSuccessMsg.style.display = 'none';
            loadEstablecimientoPanel();
        }, 2000);
    }


    // Panel de Establecimiento
    function loadEstablecimientoPanel() {
        const id = parseInt(localStorage.getItem('currentEstablecimientoId'));
        if (!id) {
            navigateTo('miestablecimiento');
            return;
        }

        const est = db.getEstablecimiento(id);
        if (!est) {
            alert('Establecimiento no encontrado.');
            logoutEstablecimiento();
            return;
        }

        document.getElementById('est-nombre-display').textContent = est.nombre;
        const sellos = db.getSellosByEstablecimiento(id);
        document.getElementById('sellos-count').textContent = sellos.length;
        const pasaportesUnicos = [...new Set(sellos.map(s => s.id_pasaporte))];
        document.getElementById('visitas-count').textContent = pasaportesUnicos.length;

        const list = document.getElementById('sellos-list');
        list.innerHTML = '';
        if (sellos.length === 0) {
            list.innerHTML = '<p>No hay sellos recibidos aún.</p>';
            return;
        }

        sellos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        sellos.slice(0, 10).forEach(s => {
            const div = document.createElement('div');
            div.style.padding = '10px';
            div.style.borderBottom = '1px solid #eee';
            div.innerHTML = `
                <div><strong>ID Pasaporte:</strong> ${s.id_pasaporte}</div>
                <div><strong>Fecha:</strong> ${new Date(s.fecha).toLocaleString()}</div>
            `;
            list.appendChild(div);
        });
    }

    window.logoutEstablecimiento = () => {
        localStorage.removeItem('currentEstablecimientoId');
        navigateTo('miestablecimiento');
    };

    // Admin Login
    const adminLoginForm = document.getElementById('admin-login-form');
    if (adminLoginForm) {
        adminLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();

            if (!document.getElementById('recaptcha-admin').checked) {
                document.getElementById('admin-login-error').textContent = 'Completa la verificación.';
                return;
            }

            const email = document.getElementById('admin-email').value.trim();
            const password = document.getElementById('admin-password').value;
            if (email === 'admin@admin.com' && password === 'admin') {
                localStorage.setItem('isAdminLoggedIn', 'true');
                navigateTo('admin');
            } else {
                document.getElementById('admin-login-error').textContent = 'Credenciales incorrectas.';
            }
        });
    }

    // Admin Panel
    window.loadAdminData = () => {
        if (localStorage.getItem('isAdminLoggedIn') !== 'true') {
            navigateTo('admin-login');
            return;
        }

        // Cargar pasaportes
        const tbodyP = document.querySelector('#pasaporte-table tbody');
        tbodyP.innerHTML = '';
        db.getTable('Pasaporte').forEach(p => {
            const sellos = db.getSellosByPasaporte(p.id_pasaporte);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><button class="action-btn" onclick="verPasaporte(${p.id_pasaporte})" title="Ver Pasaporte"><i class="fas fa-eye"></i></button></td>
                <td>${p.id_pasaporte}</td>
                <td>${p.email}</td>
                <td>${sellos.length}</td>`;
            tbodyP.appendChild(tr);
        });

        // Cargar establecimientos
        const tbodyE = document.querySelector('#establecimiento-table tbody');
        tbodyE.innerHTML = '';
        db.getTable('Establecimiento').forEach(e => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><button class="action-btn" onclick="verEstablecimiento(${e.id_establecimiento})" title="Loguearse como este establecimiento"><i class="fas fa-eye"></i></button></td>
                <td>${e.id_establecimiento}</td>
                <td>${e.nombre}</td>
                <td>${e.tipo}</td>`;
            tbodyE.appendChild(tr);
        });

        // Cargar sellos
        const tbodyS = document.querySelector('#sello-table tbody');
        tbodyS.innerHTML = '';
        db.getTable('Sello').forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${s.id_sello}</td>
                <td>${s.id_pasaporte}</td>
                <td>${s.id_establecimiento}</td>
                <td>${new Date(s.fecha).toLocaleString()}</td>
                <td>${s.activo ? 'Sí' : 'No'}</td>
            `;
            tbodyS.appendChild(tr);
        });
    };

    window.verEstablecimiento = (id) => {
        if(confirm("Se iniciará sesión automáticamente en este establecimiento. ¿Continuar?")) {
            localStorage.setItem('currentEstablecimientoId', id);
            navigateTo('miestablecimiento');
        }
    };

    // Toggle de visibilidad de contraseñas
    document.querySelectorAll('.password-container i').forEach(icon => {
        icon.addEventListener('click', function() {
            const input = this.previousElementSibling;
            input.type = input.type === 'password' ? 'text' : 'password';
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });
    });

    // Exportar DB
    window.exportDB = () => {
        const data = {};
        const keys = Object.keys(localStorage);
        keys.forEach(key => {
            data[key] = localStorage.getItem(key);
        });
        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pasaporte_vino_db.json';
        a.click();
        URL.revokeObjectURL(url);
    };

    // --- CORRECCIÓN PUNTO 3: IMPORTAR DB (RECARGA AUTOMÁTICA Y MERGE MEJORADO) ---
    window.importDB = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = event => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    const tables = ['Pasaporte', 'Establecimiento', 'Sello'];

                    tables.forEach(tableName => {
                        if(importedData[tableName]) {
                            const importedArr = JSON.parse(importedData[tableName]);
                            const currentArr = JSON.parse(localStorage.getItem(tableName) || '[]');
                            const idField = 'id_' + tableName.toLowerCase();

                            const mergeMap = new Map();

                            // 1. Cargar actuales
                            currentArr.forEach(item => {
                                mergeMap.set(item[idField], item);
                            });

                            // 2. Sobreescribir con importados (los nuevos prevalecen si el ID coincide)
                            importedArr.forEach(item => {
                                mergeMap.set(item[idField], item);
                            });

                            const finalArray = Array.from(mergeMap.values());
                            localStorage.setItem(tableName, JSON.stringify(finalArray));
                        }
                    });

                    // Otros valores (config)
                    Object.keys(importedData).forEach(key => {
                        if (!tables.includes(key) && 
                            key !== 'isAdminLoggedIn' && 
                            key !== 'currentPasaporteId' && 
                            key !== 'currentEstablecimientoId') {
                                localStorage.setItem(key, importedData[key]);
                        }
                    });

                    alert('Base de datos importada y fusionada correctamente.');
                    location.reload(); // Recarga automática (Punto 3)
                } catch (err) {
                    alert('Error al procesar el archivo: ' + err.message);
                }
            };
            reader.readAsText(file);
        };
        input.click();
    };

    window.clearTable = function(table) {
        if (confirm(`¿Estás seguro de borrar todos los datos de ${table}?`)) {
            localStorage.setItem(table, JSON.stringify([]));
            loadAdminData();
        }
    };

    // Estadísticas
    window.loadEstadisticas = () => {
        const pasaportes = db.getTable('Pasaporte');
        const establecimientos = db.getTable('Establecimiento');
        const sellos = db.getTable('Sello');

        document.getElementById('total-pasaportes').textContent = pasaportes.length;
        document.getElementById('total-establecimientos').textContent = establecimientos.length;
        document.getElementById('total-sellos').textContent = sellos.length;

        let completos = 0;
        pasaportes.forEach(p => {
            const sellosP = db.getSellosByPasaporte(p.id_pasaporte);
            const estIds = [...new Set(sellosP.map(s => s.id_establecimiento))];
            if (estIds.length >= 4) completos++;
        });
        document.getElementById('pasaportes-completos').textContent = completos;
    };

    // Alta Establecimiento
    const altaForm = document.getElementById('alta-establecimiento-form');
    if (altaForm) {
        altaForm.addEventListener('submit', (e) => {
            e.preventDefault();

            if (!document.getElementById('recaptcha-alta').checked) {
                alert('Completa la verificación.');
                return;
            }

            const nombre = document.getElementById('alta-nombre').value;
            const tipo = document.getElementById('alta-tipo').value;
            const direccion = document.getElementById('alta-direccion').value;
            const descripcion = document.getElementById('alta-descripcion').value;
            const password = document.getElementById('alta-password').value;
            const confirmPassword = document.getElementById('alta-confirm-password').value;

            if (password !== confirmPassword) {
                alert('Las contraseñas no coinciden.');
                return;
            }

            db.addEstablecimiento({
                nombre,
                tipo,
                direccion,
                descripcion,
                password
            });
            alert('¡Establecimiento registrado exitosamente!');
            altaForm.reset();
        });
    }

    document.getElementById('search-input').addEventListener('input', filterEstablecimientos);
});
</script>
</body>
</html>