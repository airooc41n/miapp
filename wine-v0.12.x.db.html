<button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
</div>
</section>

<section id="establecimientos" class="page">
<h1>Nuestros Establecimientos</h1>
<div class="establecimientos-grid" id="establecimientos-list"></div>
<div id="search-container">
<input type="text" id="search-input" placeholder="Buscar establecimiento...">
<i class="fas fa-search" id="search-icon"></i>
</div>
</section>

<section id="miestablecimiento" class="page">
<h1>Mi Establecimiento</h1>
<div id="mi-establecimiento-form-container" class="mi-establecimiento-form">
<form id="mi-establecimiento-login-form">
<label for="mi-est-email">Email del Establecimiento:</label>
<input type="email" id="mi-est-email" required placeholder="ejemplo@establecimiento.com">
<label for="mi-est-password">Contraseña:</label>
<div class="password-container">
<input type="password" id="mi-est-password" required placeholder="Contraseña del establecimiento">
<i class="fas fa-eye" id="toggle-mi-est-password"></i>
</div>
<div class="recaptcha-box">
    <div class="recaptcha-left">
        <input type="checkbox" id="recaptcha-est-login" class="recaptcha-checkbox" required>
        <label for="recaptcha-est-login" class="recaptcha-label">No soy un robot</label>
    </div>
    <div class="recaptcha-right">
        <div class="recaptcha-logo"></div>
        <div class="recaptcha-text">reCAPTCHA<br><a href="#">Privacidad</a> - <a href="#">Términos</a></div>
    </div>
</div>
<button type="submit">Iniciar Sesión</button>
</form>
</div>
<div id="mi-establecimiento-panel" style="display: none; margin-top: 30px;">
<div class="est-panel">
<div id="est-info">
<h2>Bienvenido, <span id="est-nombre-display"></span></h2>
<div class="est-controls">
    <button class="scan-btn" onclick="startScanningOverlay()"><i class="fas fa-qrcode"></i> Escanear QR</button>
    <button class="logout-btn" onclick="logoutEstablecimiento()" style="margin-top:0;">Cerrar Sesión</button>
</div>
<div class="est-stats">
<div class="stat-card">
<div class="stat-value" id="sellos-count">0</div>
<div class="stat-label">Sellos Recibidos</div>
</div>
<div class="stat-card">
<div class="stat-value" id="visitas-count">0</div>
<div class="stat-label">Visitantes Diferentes</div>
</div>
</div>
</div>
<h3>Sellos Recibidos Recientes</h3>
<div class="sellos-received-list" id="sellos-list"></div>
</div>
</div>
</section>

<section id="admin-login" class="page">
<h1>Acceso Administrador</h1>
<div class="admin-login-form">
<form id="admin-login-form">
<label for="admin-email">Email:</label>
<input type="email" id="admin-email" placeholder="admin@admin.com" required>
<label for="admin-password">Contraseña:</label>
<div class="password-container">
<input type="password" id="admin-password" placeholder="admin" required>
<i class="fas fa-eye" id="toggle-admin-password"></i>
</div>
<div class="recaptcha-box">
    <div class="recaptcha-left">
        <input type="checkbox" id="recaptcha-admin" class="recaptcha-checkbox" required>
        <label for="recaptcha-admin" class="recaptcha-label">No soy un robot</label>
    </div>
    <div class="recaptcha-right">
        <div class="recaptcha-logo"></div>
        <div class="recaptcha-text">reCAPTCHA<br><a href="#">Privacidad</a> - <a href="#">Términos</a></div>
    </div>
</div>
<button type="submit">Acceder</button>
</form>
</div>
<div id="admin-login-error"></div>
</section>

<section id="admin" class="page">
<h1>Panel de Administración</h1>
<div class="table-wrapper">
<h2>Pasaportes</h2>
<table id="pasaporte-table">
<thead>
<tr>
    <th>Ver</th>
    <th onclick="sortTable('pasaporte-table', 1, 'number')">ID</th>
    <th onclick="sortTable('pasaporte-table', 2, 'text')">Email</th>
    <th>Sellos</th>
    <th onclick="sortTable('pasaporte-table', 4, 'text')">Nombre</th>
    <th onclick="sortTable('pasaporte-table', 5, 'text')">Tlf</th>
    <th onclick="sortTable('pasaporte-table', 6, 'text')">Cond.</th>
    <th onclick="sortTable('pasaporte-table', 7, 'text')">Subs.</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="table-wrapper">
<h2>Establecimientos</h2>
<table id="establecimiento-table">
<thead>
<tr>
    <th>Ver</th>
    <th onclick="sortTable('establecimiento-table', 1, 'number')">ID</th>
    <th onclick="sortTable('establecimiento-table', 2, 'text')">Nombre</th>
    <th onclick="sortTable('establecimiento-table', 3, 'text')">Email</th>
    <th onclick="sortTable('establecimiento-table', 4, 'text')">Tipo</th>
    <th onclick="sortTable('establecimiento-table', 5, 'text')">Dirección</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="table-wrapper">
<h2>Sellos</h2>
<table id="sello-table">
<thead>
<tr>
    <th onclick="sortTable('sello-table', 0, 'number')">ID Pasaporte</th>
    <th onclick="sortTable('sello-table', 1, 'number')">ID Establecimiento</th>
    <th onclick="sortTable('sello-table', 2, 'date')">Fecha Registro</th>
    <th onclick="sortTable('sello-table', 3, 'date')">Fecha Caducidad</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</section>

<section id="estadisticas" class="page">
<h1>Estadísticas de la Aplicación</h1>
<div class="stats-overview">
<div class="stats-grid">
<div class="stat-item">
<div class="stat-number" id="total-pasaportes">0</div>
<div class="stat-title">Pasaportes Registrados</div>
</div>
<div class="stat-item">
<div class="stat-number" id="total-establecimientos">0</div>
<div class="stat-title">Establecimientos Adheridos</div>
</div>
<div class="stat-item">
<div class="stat-number" id="total-sellos">0</div>
<div class="stat-title">Sellos Emitidos</div>
</div>
<div class="stat-item">
<div class="stat-number" id="pasaportes-completos">0</div>
<div class="stat-title">Pasaportes Completos (4+ sellos)</div>
</div>
</div>
</div>
</section>

<section id="altaestablecimiento" class="page">
<h1>Alta de Establecimiento</h1>
<div class="mi-establecimiento-form">
<form id="alta-establecimiento-form">
<label for="alta-email">Email (Login):</label>
<input type="email" id="alta-email" required placeholder="email@establecimiento.com">

<label for="alta-nombre">Nombre del Establecimiento:</label>
<input type="text" id="alta-nombre" required placeholder="Ej. Bodegas Familiares">
<label for="alta-tipo">Tipo:</label>
<select id="alta-tipo" required>
<option value="Bodega">Bodega</option>
<option value="Restaurante">Restaurante</option>
<option value="Museo">Museo</option>
<option value="Alojamiento">Alojamiento</option>
<option value="Vinoteca">Vinoteca</option>
</select>
<label for="alta-direccion">Dirección:</label>
<input type="text" id="alta-direccion" required placeholder="Calle, Localidad...">
<label for="alta-descripcion">Descripción Corta:</label>
<textarea id="alta-descripcion" rows="3" required placeholder="Breve descripción de la experiencia..."></textarea>
<label for="alta-password">Contraseña:</label>
<div class="password-container">
<input type="password" id="alta-password" required>
<i class="fas fa-eye" id="toggle-alta-password"></i>
</div>
<label for="alta-confirm-password">Confirmar Contraseña:</label>
<div class="password-container">
<input type="password" id="alta-confirm-password" required>
<i class="fas fa-eye" id="toggle-alta-confirm-password"></i>
</div>
<div class="recaptcha-box">
    <div class="recaptcha-left">
        <input type="checkbox" id="recaptcha-alta" class="recaptcha-checkbox" required>
        <label for="recaptcha-alta" class="recaptcha-label">No soy un robot</label>
    </div>
    <div class="recaptcha-right">
        <div class="recaptcha-logo"></div>
        <div class="recaptcha-text">reCAPTCHA<br><a href="#">Privacidad</a> - <a href="#">Términos</a></div>
    </div>
</div>
<button type="submit">Registrar Establecimiento</button>
</form>
</div>
</section>
</main>

<div id="scanner-overlay">
    <h1 style="color: white; margin-bottom: 24px; font-size: 2rem;">Escanear QR</h1>
    <div id="camera-window">
        <canvas id="scanner-canvas"></canvas>
        <button id="btn-sellar-overlay" onclick="sellarDesdeScanner()">Sellar</button>
    </div>
    <div id="qr-result-label">Buscando código QR...</div>
    <button onclick="stopScanningOverlay()" style="margin-top: 24px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); color: white; padding: 12px 32px; border-radius: var(--radius-md); cursor:pointer; font-size: 1rem; font-weight: 600; backdrop-filter: blur(10px); transition: var(--transition-normal);">Cancelar</button>
</div>

<div id="scanner-success-msg">
    <div style="font-size: 3rem; margin-bottom: 10px;">✅</div>
    Su pasaporte ha sido sellado con éxito
</div>

<footer>
    <div class="footer-icon" onclick="navigateTo('registrar')">
        <i class="fas fa-plus"></i><span>Registrar</span>
    </div>
    <div class="footer-icon" onclick="navigateTo('mipasaporte')">
        <i class="fas fa-passport"></i><span>Pasaporte</span>
    </div>
    <div class="footer-icon" onclick="navigateTo('establecimientos')">
        <i class="fas fa-store"></i><span>Establec.</span>
    </div>
    <div class="footer-icon" onclick="navigateTo('miestablecimiento')">
        <i class="fas fa-user-tie"></i><span>Mi Establec.</span>
    </div>
    <div class="footer-icon" onclick="navigateTo('admin')">
        <i class="fas fa-cogs"></i><span>Admin</span>
    </div>
</footer>

<script>
// --- CONFIGURACIÓN SUPABASE ---
const SB_URL = 'https://ggpuicskbxgdelvghnte.supabase.co';
const SB_KEY = 'sb_publishable_2bdk3ULr8fwqv_D8zn6yMw_Vl-HiEl-'; // Usar exactamente la proporcionada
const { createClient } = supabase;
const _supabase = createClient(SB_URL, SB_KEY);

// Variables globales para ordenación
let currentSort = { tableId: null, columnIndex: null, direction: 'asc', type: null };

document.addEventListener('DOMContentLoaded', () => {
    // --- VARIABLES ESCÁNER ---
    const scannerVideo = document.createElement("video");
    const scannerCanvasElement = document.getElementById("scanner-canvas");
    const scannerCanvas = scannerCanvasElement.getContext("2d", { willReadFrequently: true });
    const scannerOverlay = document.getElementById("scanner-overlay");
    const cameraWindow = document.getElementById("camera-window");
    const resultLabel = document.getElementById("qr-result-label");
    const btnSellarOverlay = document.getElementById("btn-sellar-overlay");
    const scannerSuccessMsg = document.getElementById("scanner-success-msg");

    let scanning = false;
    let localStream = null;
    let currentQRData = null;

    // Menu contextual
    const menuIcon = document.getElementById('menu-icon');
    const menu = document.getElementById('menu');
    const closeMenuBtn = menu.querySelector('.close');
    const overlay = document.getElementById('overlay');
    const pages = document.querySelectorAll('.page');
    const menuItems = document.getElementById('menu-items');

    function toggleMenu() {
        menu.classList.toggle('active');
        overlay.classList.toggle('active');
        loadContextItems();
    }

    menuIcon.addEventListener('click', toggleMenu);
    closeMenuBtn.addEventListener('click', toggleMenu);
    overlay.addEventListener('click', () => { if (menu.classList.contains('active')) toggleMenu(); });

    function loadContextItems() {
        menuItems.innerHTML = '';
        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get('page') || 'inicio';
        const adminPages = ['admin', 'estadisticas', 'altaestablecimiento'];
        let items = adminPages.includes(page) ? ['Estadísticas', 'Alta Establecimiento', 'Term. y Condiciones', 'Inicio'] : ['Term. y Condiciones', 'Inicio'];
        
        items.forEach(item => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.textContent = item;
            a.href = '#';
            a.onclick = (e) => {
                e.preventDefault();
                if (item === 'Alta Establecimiento') navigateTo('altaestablecimiento');
                else if (item === 'Estadísticas') navigateTo('estadisticas');
                else if (item === 'Term. y Condiciones') navigateTo('terminos');
                else if (item === 'Inicio') navigateTo('inicio');
                toggleMenu();
            };
            const icon = document.createElement('i');
            if (item === 'Estadísticas') icon.className = 'fas fa-chart-bar';
            else if (item === 'Alta Establecimiento') icon.className = 'fas fa-plus-circle';
            else if (item === 'Term. y Condiciones') icon.className = 'fas fa-file-contract';
            else if (item === 'Inicio') icon.className = 'fas fa-home';
            else icon.className = 'fas fa-circle';
            a.prepend(icon); li.appendChild(a); menuItems.appendChild(li);
        });
    }

    window.navigateTo = function(page) {
        history.pushState(null, '', `?page=${page}`);
        loadPage();
    };

    function loadPage() {
        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get('page') || 'inicio';
        
        // Limpiar todas las páginas
        pages.forEach(p => p.classList.remove('active'));
        
        // Mostrar página activa
        const activePage = document.getElementById(page);
        if (activePage) {
            activePage.classList.add('active');
        } else {
            document.getElementById('inicio').classList.add('active');
        }

        // Lógica específica para cada página
        if (page === 'mipasaporte') {
            // Si venimos del admin, mostrar botón de volver
            if (localStorage.getItem('fromAdmin') === 'true') {
                // Forzar logout primero para limpiar sesión anterior
                localStorage.removeItem('currentPasaporteId');
                // Establecer la sesión con el ID que viene del admin
                const urlId = urlParams.get('Id');
                if (urlId) {
                    localStorage.setItem('currentPasaporteId', urlId);
                }
            }
            loadPasaporteInfo();
        }
        
        if (page === 'miestablecimiento') {
            // Si venimos del admin, mostrar botón de volver
            if (localStorage.getItem('fromAdmin') === 'true') {
                // Forzar logout primero para limpiar sesión anterior
                localStorage.removeItem('currentEstablecimientoId');
                // Establecer la sesión con el ID que viene del admin
                const urlId = urlParams.get('Id');
                if (urlId) {
                    localStorage.setItem('currentEstablecimientoId', urlId);
                }
            }
            
            const idEst = localStorage.getItem('currentEstablecimientoId');
            const loginFormContainer = document.getElementById('mi-establecimiento-form-container');
            const panel = document.getElementById('mi-establecimiento-panel');
            
            if (idEst) {
                loginFormContainer.style.display = 'none';
                panel.style.display = 'block';
                loadEstablecimientoPanel();
            } else {
                loginFormContainer.style.display = 'block';
                document.getElementById('mi-establecimiento-login-form').reset();
                panel.style.display = 'none';
            }
        }
        
        if (page === 'admin') {
            // Restaurar sesión admin si venimos de ver un pasaporte/establecimiento
            if (localStorage.getItem('tempAdminSession') === 'true') {
                localStorage.setItem('isAdminLoggedIn', 'true');
                localStorage.removeItem('tempAdminSession');
            }
            
            if (localStorage.getItem('isAdminLoggedIn') === 'true') {
                loadAdminData();
            } else {
                navigateTo('admin-login');
            }
        }
        
        if (page === 'establecimientos') {
            renderEstablecimientos();
            document.getElementById('search-input').value = '';
        }
        
        if (page === 'registrar') {
            const form = document.getElementById('register-form');
            form.reset();
            document.getElementById('post-register-actions').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('qr-code').innerHTML = '';
            document.getElementById('condiciones-check').checked = true;
            document.getElementById('newsletter-check').checked = true;
        }
        
        if (page === 'estadisticas') loadEstadisticas();
    }

    window.addEventListener('popstate', loadPage);
    
    // --- HELPERS ---
    const formatDate = (iso) => {
        if(!iso) return '';
        const d = new Date(iso);
        // Formato DD/MM/AAAA
        return `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}`;
    };
    
    const getExpiry = () => {
        const d = new Date();
        d.setFullYear(d.getFullYear() + 1);
        return d.toISOString();
    };

    // --- DB ACTIONS (SUPABASE) ---
    window.db = {
        addPasaporte: async (data) => {
            const { data: res, error } = await _supabase.from('Pasaporte').insert([data]).select().single();
            if (error) throw error;
            return res;
        },
        getPasaporte: async (id) => {
            const { data, error } = await _supabase.from('Pasaporte').select('*').eq('id', id).single();
            if (error) return null;
            return data;
        },
        getPasaporteByEmail: async (email) => {
            const { data, error } = await _supabase.from('Pasaporte').select('*').eq('email', email).single();
            if (error) return null;
            return data;
        },
        loginPasaporte: async (email, passwd) => {
            const { data, error } = await _supabase.from('Pasaporte').select('*').eq('email', email).eq('passwd', passwd).single();
            if (error) return null;
            return data;
        },
        getSellosByPasaporte: async (id) => {
            const { data, error } = await _supabase.from('Sello').select('*').eq('id_pasaporte', id);
            if (error) return [];
            return data;
        },
        addEstablecimiento: async (data) => {
            const { data: res, error } = await _supabase.from('Establecimiento').insert([data]).select().single();
            if (error) throw error;
            return res;
        },
        getEstablecimiento: async (id) => {
            const { data, error } = await _supabase.from('Establecimiento').select('*').eq('id', id).single();
            if (error) return null;
            return data;
        },
        loginEstablecimiento: async (email, passwd) => {
            const { data, error } = await _supabase.from('Establecimiento').select('*').eq('email', email).eq('passwd', passwd).single();
            if (error) return null;
            return data;
        },
        getAllEstablecimientos: async () => {
            const { data, error } = await _supabase.from('Establecimiento').select('*');
            if (error) return [];
            return data;
        },
        addSello: async (data) => {
            const { data: res, error } = await _supabase.from('Sello').insert([data]).select().single();
            if (error) throw error;
            return res;
        },
        getSellosByEstablecimiento: async (id) => {
            const { data, error } = await _supabase.from('Sello').select('*').eq('id_establecimiento', id);
            if (error) return [];
            return data;
        },
        checkSelloExists: async (pid, eid) => {
            const { data, error } = await _supabase.from('Sello').select('*').eq('id_pasaporte', pid).eq('id_establecimiento', eid).maybeSingle();
            if (error) return false;
            return !!data;
        },
        // Helpers para Admin
        getTable: async (table) => {
            const { data, error } = await _supabase.from(table).select('*');
            if (error) return [];
            return data;
        },
        // Nueva función para obtener config admin
        getAdminConfig: async () => {
            try {
                const { data, error } = await _supabase.from('config').select('param').eq('id', 1).single();
                if (error) return null;
                return data.param; // JSON: {email: "...", passwd: "..."}
            } catch (e) {
                console.error('Error obteniendo config admin:', e);
                return null;
            }
        }
    };

    // --- LOGICA UI ---

    // Registro
    const registerForm = document.getElementById('register-form');
    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const err = document.getElementById('error-message');
        const succ = document.getElementById('success-message');
        const qrDiv = document.getElementById('qr-code');
        err.style.display = 'none'; succ.style.display = 'none'; qrDiv.innerHTML = '';

        if (!document.getElementById('recaptcha-registrar').checked) {
            err.textContent = 'Completa la verificación.'; err.style.display = 'block'; return;
        }
        if (!document.getElementById('condiciones-check').checked) {
            err.textContent = 'Debe aceptar las condiciones.'; err.style.display = 'block'; return;
        }
        
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const nombre = document.getElementById('nombre').value.trim();
        
        if (password !== document.getElementById('confirm-password').value) {
            err.textContent = 'Las contraseñas no coinciden.'; err.style.display = 'block'; return;
        }

        try {
            // Check duplicado
            const existing = await db.getPasaporteByEmail(email);
            if (existing) {
                err.textContent = 'El email ya está registrado.'; err.style.display = 'block'; return;
            }

            const newP = await db.addPasaporte({ 
                email, 
                passwd: password, 
                nombre: nombre,
                tlf: document.getElementById('tlf').value,
                acep_cond: document.getElementById('condiciones-check').checked,
                suscrito: document.getElementById('newsletter-check').checked
            });
            
            succ.textContent = '¡Pasaporte creado con éxito!'; succ.style.display = 'block';
            const qrUrl = `${window.location.origin}${window.location.pathname}?page=mipasaporte&email=${encodeURIComponent(email)}&Id=${newP.id}`;
            new QRCode(qrDiv, { text: qrUrl, width: 300, height: 300, colorDark: "#8B1E3F", colorLight: "#FFFFFF", correctLevel: QRCode.CorrectLevel.H });
            
            localStorage.setItem('currentPasaporteId', newP.id);
            document.getElementById('post-register-actions').style.display = 'block';
            registerForm.style.display = 'none';
        } catch (ex) {
            console.error(ex);
            err.textContent = 'Error al registrar: ' + ex.message; err.style.display = 'block';
        }
    });

    // Login Pasaporte
    const loginForm = document.getElementById('login-form');
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const loginError = document.getElementById('login-error');
        loginError.style.display = 'none';

        if (!document.getElementById('recaptcha-login').checked) {
            loginError.textContent = 'Completa la verificación.'; loginError.style.display = 'block'; return;
        }

        const email = document.getElementById('login-email').value.trim();
        const pass = document.getElementById('login-password').value;
        
        try {
            const p = await db.loginPasaporte(email, pass);
            if (!p) {
                loginError.textContent = 'Credenciales incorrectas.'; loginError.style.display = 'block'; return;
            }
            localStorage.setItem('currentPasaporteId', p.id);
            loadPasaporteInfo();
        } catch(ex) {
            loginError.textContent = 'Error de conexión.'; loginError.style.display = 'block';
        }
    });

    async function loadPasaporteInfo() {
        const id = localStorage.getItem('currentPasaporteId');
        const info = document.getElementById('pasaporte-info');
        const loginF = document.getElementById('login-form');
        const premioSection = document.getElementById('premio-section');

        if (!id) { 
            loginF.style.display = 'block'; 
            info.style.display = 'none'; 
            return; 
        }

        try {
            const p = await db.getPasaporte(id);
            if (!p) { logout(); return; }

            loginF.style.display = 'none';
            info.style.display = 'block';
            document.getElementById('pasaporte-email').textContent = `Email: ${p.email}`;
            
            const sellos = await db.getSellosByPasaporte(id);
            document.getElementById('pasaporte-sellos').textContent = `Sellos: ${sellos.length}`;

            // Lógica de premio (4 sellos distintos)
            const estIds = [...new Set(sellos.map(s => s.id_establecimiento))];
            if (estIds.length >= 4) {
                premioSection.style.display = 'block';
                premioSection.innerHTML = '<div class="premio-section"><h3>¡Enhorabuena! Tienes 4 sellos diferentes.</h3><p>Puedes reclamar tu premio.</p></div>';
            } else {
                premioSection.style.display = 'none';
            }

            const qrCont = document.getElementById('pasaporte-qr');
            qrCont.innerHTML = '';
            const qrUrl = `${window.location.origin}${window.location.pathname}?page=mipasaporte&email=${encodeURIComponent(p.email)}&Id=${p.id}`;
            new QRCode(qrCont, { text: qrUrl, width: 250, height: 250, colorDark: "#8B1E3F", colorLight: "#FFFFFF", correctLevel: QRCode.CorrectLevel.H });

            // Agregar botón "Volver a Admin" si venimos del admin
            const existingBackBtn = document.getElementById('back-to-admin-btn');
            if (existingBackBtn) existingBackBtn.remove();
            
            if (localStorage.getItem('fromAdmin') === 'true') {
                const backBtn = document.createElement('button');
                backBtn.id = 'back-to-admin-btn';
                backBtn.className = 'logout-btn';
                backBtn.textContent = 'Volver a Admin';
                backBtn.onclick = () => {
                    localStorage.removeItem('fromAdmin');
                    localStorage.removeItem('currentPasaporteId');
                    navigateTo('admin');
                };
                
                // Insertar después del botón de logout
                const logoutBtn = document.querySelector('.logout-btn');
                if (logoutBtn) {
                    logoutBtn.parentNode.insertBefore(backBtn, logoutBtn.nextSibling);
                } else {
                    info.appendChild(backBtn);
                }
            }
        } catch (e) { console.error(e); }
    }

    window.logout = () => { 
        localStorage.removeItem('currentPasaporteId'); 
        localStorage.removeItem('fromAdmin');
        loadPasaporteInfo(); 
    };

    // Render Establecimientos
    window.renderEstablecimientos = async () => {
        const list = document.getElementById('establecimientos-list');
        list.innerHTML = '<p>Cargando...</p>';
        
        const ests = await db.getAllEstablecimientos();
        list.innerHTML = '';

        ests.forEach(est => {
            const card = document.createElement('div');
            card.className = 'est-card';
            let iconClass = 'fa-building';
            if(est.type === 'Bodega') iconClass = 'fa-wine-bottle';
            if(est.type === 'Restaurante') iconClass = 'fa-utensils';
            if(est.type === 'Museo') iconClass = 'fa-landmark';
            if(est.type === 'Alojamiento') iconClass = 'fa-bed';
            if(est.type === 'Vinoteca') iconClass = 'fa-glass-cheers';

            // Usamos los campos nuevos de la DB
            card.innerHTML = `
            <div class="est-header">
                <i class="fas ${iconClass}" style="font-size: 2.5em; opacity: 0.9;"></i>
                <span class="est-type-badge">${est.type || 'Varios'}</span>
            </div>
            <div class="est-body">
                <h3>${est.nombre || 'Sin nombre'}</h3>
                <p><i class="fas fa-map-marker-alt"></i> ${est.direccion || ''}</p>
                <p>${est.descripcion || ''}</p>
            </div>
            `;
            card.dataset.nombre = (est.nombre || '').toLowerCase();
            card.dataset.tipo = (est.type || '').toLowerCase();
            card.dataset.direccion = (est.direccion || '').toLowerCase();
            list.appendChild(card);
        });
    };

    window.filterEstablecimientos = () => {
        const query = document.getElementById('search-input').value.toLowerCase().trim();
        const cards = document.querySelectorAll('.est-card');
        cards.forEach(card => {
            const match = (card.dataset.nombre || '').includes(query) || (card.dataset.tipo || '').includes(query) || (card.dataset.direccion || '').includes(query);
            card.style.display = match ? 'flex' : 'none';
        });
    };

    // Login Establecimiento
    const miEstLoginForm = document.getElementById('mi-establecimiento-login-form');
    if (miEstLoginForm) {
        miEstLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!document.getElementById('recaptcha-est-login').checked) { alert('Completa la verificación.'); return; }

            const email = document.getElementById('mi-est-email').value.trim();
            const password = document.getElementById('mi-est-password').value;
            
            try {
                const est = await db.loginEstablecimiento(email, password);
                if (!est) { alert('Credenciales incorrectas.'); return; }
                
                localStorage.setItem('currentEstablecimientoId', est.id);
                document.getElementById('mi-establecimiento-form-container').style.display = 'none';
                document.getElementById('mi-establecimiento-panel').style.display = 'block';
                loadEstablecimientoPanel();
            } catch(ex) { alert('Error de conexión.'); }
        });
    }

    async function loadEstablecimientoPanel() {
        const id = localStorage.getItem('currentEstablecimientoId');
        if (!id) { navigateTo('miestablecimiento'); return; }

        try {
            const est = await db.getEstablecimiento(id);
            if (!est) { logoutEstablecimiento(); return; }

            document.getElementById('est-nombre-display').textContent = est.nombre;
            const sellos = await db.getSellosByEstablecimiento(id);
            document.getElementById('sellos-count').textContent = sellos.length;
            const pasaportesUnicos = [...new Set(sellos.map(s => s.id_pasaporte))];
            document.getElementById('visitas-count').textContent = pasaportesUnicos.length;

            const list = document.getElementById('sellos-list');
            list.innerHTML = '';
            if (sellos.length === 0) {
                list.innerHTML = '<p style="padding: 20px; text-align:center;">No hay sellos.</p>';
            } else {
                // Ordenar por fecha (string ISO)
                sellos.sort((a, b) => new Date(b.fecha_reg) - new Date(a.fecha_reg));
                sellos.slice(0, 10).forEach(s => {
                    const div = document.createElement('div');
                    div.style.padding = '12px'; div.style.borderBottom = '1px solid var(--border)';
                    div.innerHTML = `<div><strong>ID Pasaporte:</strong> ${s.id_pasaporte}</div><div><strong>Fecha:</strong> ${formatDate(s.fecha_reg)}</div>`;
                    list.appendChild(div);
                });
            }

            // Agregar botón "Volver a Admin" si venimos del admin
            const existingBackBtn = document.getElementById('back-to-admin-btn-est');
            if (existingBackBtn) existingBackBtn.remove();
            
            if (localStorage.getItem('fromAdmin') === 'true') {
                const backBtn = document.createElement('button');
                backBtn.id = 'back-to-admin-btn-est';
                backBtn.className = 'logout-btn';
                backBtn.textContent = 'Volver a Admin';
                backBtn.style.marginTop = '10px';
                backBtn.onclick = () => {
                    localStorage.removeItem('fromAdmin');
                    localStorage.removeItem('currentEstablecimientoId');
                    navigateTo('admin');
                };
                
                // Insertar en los controles
                const estControls = document.querySelector('.est-controls');
                if (estControls) {
                    estControls.appendChild(backBtn);
                }
            }
        } catch(e) { console.error(e); }
    }

    window.logoutEstablecimiento = () => { 
        localStorage.removeItem('currentEstablecimientoId'); 
        localStorage.removeItem('fromAdmin');
        navigateTo('miestablecimiento'); 
    };

    // --- ESCANER ---
    window.startScanningOverlay = function() {
        scannerOverlay.style.display = "flex";
        btnSellarOverlay.style.display = "none";
        cameraWindow.classList.remove("detected");
        resultLabel.innerText = "Buscando código QR...";
        scannerSuccessMsg.style.display = 'none';
        scanning = true;

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
            localStream = stream; scannerVideo.srcObject = stream; scannerVideo.setAttribute("playsinline", true); scannerVideo.play();
            requestAnimationFrame(tickOverlay);
        }).catch(function(err) { alert("Error cámara: " + err); stopScanningOverlay(); });
    }

    function tickOverlay() {
        if (!scanning) return;
        if (scannerVideo.readyState === scannerVideo.HAVE_ENOUGH_DATA) {
            scannerCanvasElement.height = scannerVideo.videoHeight; scannerCanvasElement.width = scannerVideo.videoWidth;
            scannerCanvas.drawImage(scannerVideo, 0, 0, scannerCanvasElement.width, scannerCanvasElement.height);
            var imageData = scannerCanvas.getImageData(0, 0, scannerCanvasElement.width, scannerCanvasElement.height);
            var code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
            if (code) {
                if (!cameraWindow.classList.contains("detected")) cameraWindow.classList.add("detected");
                resultLabel.innerText = "Detectado.";
                currentQRData = code.data;
                if (btnSellarOverlay.style.display !== "block") {
                    btnSellarOverlay.style.display = "block";
                    if (window.navigator && window.navigator.vibrate) window.navigator.vibrate(200);
                }
            }
        }
        requestAnimationFrame(tickOverlay);
    }

    window.stopScanningOverlay = function() {
        scanning = false; if (localStream) localStream.getTracks().forEach(track => track.stop()); scannerOverlay.style.display = "none";
    }

    window.sellarDesdeScanner = async function() {
        if (!currentQRData) return;
        const urlParams = new URLSearchParams(currentQRData);
        let idPasaporte = urlParams.get('Id');
        if (!idPasaporte && currentQRData.includes('Id=')) idPasaporte = currentQRData.split('Id=')[1].split('&')[0];
        if (!idPasaporte) { alert('QR no válido.'); return; }

        const currentEstId = localStorage.getItem('currentEstablecimientoId');
        if (!currentEstId) { alert('Sesión caducada.'); stopScanningOverlay(); return; }

        try {
            // Verificar pasaporte existe
            const pass = await db.getPasaporte(idPasaporte);
            if (!pass) { alert('Pasaporte no encontrado en DB.'); return; }

            // Verificar si ya tiene sello
            const exists = await db.checkSelloExists(idPasaporte, currentEstId);
            if (exists) { alert('Este pasaporte ya tiene tu sello.'); return; }

            // Insertar Sello
            await db.addSello({
                id_pasaporte: idPasaporte,
                id_establecimiento: currentEstId,
                fecha_reg: new Date().toISOString(),
                fecha_cad: getExpiry() // Calcula 1 año despues
            });

            scanning = false; if (localStream) localStream.getTracks().forEach(track => track.stop()); scannerOverlay.style.display = "none";
            scannerSuccessMsg.style.display = 'block';
            setTimeout(() => { scannerSuccessMsg.style.display = 'none'; loadEstablecimientoPanel(); }, 2000);

        } catch (ex) {
            alert('Error al sellar: ' + ex.message);
        }
    }

    // --- ADMIN ---
    const adminLoginForm = document.getElementById('admin-login-form');
    if (adminLoginForm) {
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!document.getElementById('recaptcha-admin').checked) { 
                alert('Verifica recaptcha'); 
                return; 
            }
            
            const inputEmail = document.getElementById('admin-email').value;
            const inputPass = document.getElementById('admin-password').value;
            
            try {
                let valid = false;
                // Intentar obtener credenciales de Supabase
                const config = await db.getAdminConfig();
                
                if (config && config.email && config.passwd) {
                    // Usar credenciales de Supabase
                    valid = (inputEmail === config.email && inputPass === config.passwd);
                } else {
                    // Fallback a hardcoded (solo para desarrollo/demo)
                    console.warn('Usando credenciales hardcodeadas - config no encontrada');
                    valid = (inputEmail === 'admin@admin.com' && inputPass === 'admin');
                }
                
                if (valid) {
                    localStorage.setItem('isAdminLoggedIn', 'true');
                    navigateTo('admin');
                } else {
                    alert('Credenciales incorrectas');
                }
            } catch (ex) {
                console.error('Error en login admin:', ex);
                alert('Error de conexión');
            }
        });
    }

    window.loadAdminData = async () => {
        if (localStorage.getItem('isAdminLoggedIn') !== 'true') { navigateTo('admin-login'); return; }

        // Obtener todos los datos necesarios
        const [pasaportes, establecimientos, sellos] = await Promise.all([
            db.getTable('Pasaporte'),
            db.getTable('Establecimiento'),
            db.getTable('Sello')
        ]);

        // Contar sellos por pasaporte
        const conteoSellos = {};
        sellos.forEach(s => {
            if (!conteoSellos[s.id_pasaporte]) conteoSellos[s.id_pasaporte] = 0;
            conteoSellos[s.id_pasaporte]++;
        });

        // Pasaportes
        const tbodyP = document.querySelector('#pasaporte-table tbody');
        tbodyP.innerHTML = '';
        pasaportes.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><i class="fas fa-eye action-btn" style="color: var(--primary); cursor: pointer;" 
                    onclick="viewPasaporteAsAdmin(${p.id})" 
                    title="Ver pasaporte"></i></td>
                <td>${p.id}</td>
                <td>${p.email}</td>
                <td>${conteoSellos[p.id] || 0}</td>
                <td>${p.nombre || '-'}</td>
                <td>${p.tlf || '-'}</td>
                <td>${p.acep_cond ? 'Sí' : 'No'}</td>
                <td>${p.suscrito ? 'Sí' : 'No'}</td>`;
            tbodyP.appendChild(tr);
        });

        // Establecimientos
        const tbodyE = document.querySelector('#establecimiento-table tbody');
        tbodyE.innerHTML = '';
        establecimientos.forEach(e => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><i class="fas fa-eye action-btn" style="color: var(--primary); cursor: pointer;" 
                    onclick="viewEstablecimientoAsAdmin(${e.id})" 
                    title="Ver establecimiento"></i></td>
                <td>${e.id}</td>
                <td>${e.nombre || '-'}</td>
                <td>${e.email}</td>
                <td>${e.type || '-'}</td>
                <td>${e.direccion || '-'}</td>`;
            tbodyE.appendChild(tr);
        });

        // Sellos
        const tbodyS = document.querySelector('#sello-table tbody');
        tbodyS.innerHTML = '';
        sellos.forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${s.id_pasaporte}</td>
                <td>${s.id_establecimiento}</td>
                <td>${formatDate(s.fecha_reg)}</td>
                <td>${formatDate(s.fecha_cad)}</td>`;
            tbodyS.appendChild(tr);
        });
    };

    // Nueva función para ver pasaporte como admin
    window.viewPasaporteAsAdmin = async (id) => {
        // Guardar que venimos del admin
        localStorage.setItem('fromAdmin', 'true');
        // Guardar sesión admin actual
        localStorage.setItem('tempAdminSession', localStorage.getItem('isAdminLoggedIn'));
        localStorage.removeItem('isAdminLoggedIn');
        // Forzar carga del pasaporte específico
        localStorage.setItem('currentPasaporteId', id);
        navigateTo('mipasaporte');
    };

    // Nueva función para ver establecimiento como admin
    window.viewEstablecimientoAsAdmin = async (id) => {
        // Guardar que venimos del admin
        localStorage.setItem('fromAdmin', 'true');
        // Guardar sesión admin actual
        localStorage.setItem('tempAdminSession', localStorage.getItem('isAdminLoggedIn'));
        localStorage.removeItem('isAdminLoggedIn');
        // Forzar carga del establecimiento específico
        localStorage.setItem('currentEstablecimientoId', id);
        navigateTo('miestablecimiento');
    };

    // Alta Establecimiento
    const altaForm = document.getElementById('alta-establecimiento-form');
    if (altaForm) {
        altaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!document.getElementById('recaptcha-alta').checked) { alert('Verifica recaptcha'); return; }

            const pass = document.getElementById('alta-password').value;
            if (pass !== document.getElementById('alta-confirm-password').value) { alert('Contraseñas no coinciden'); return; }
            
            // Check duplicado email
            const email = document.getElementById('alta-email').value.trim();
            // No tenemos funcion checkEmailEstablecimiento expuesta pero insert fallará por unique constraint
            
            try {
                await db.addEstablecimiento({
                    email: email,
                    passwd: pass,
                    nombre: document.getElementById('alta-nombre').value,
                    type: document.getElementById('alta-tipo').value,
                    direccion: document.getElementById('alta-direccion').value,
                    descripcion: document.getElementById('alta-descripcion').value
                });
                alert('Establecimiento registrado.');
                altaForm.reset();
            } catch (ex) { alert('Error al registrar (posible email duplicado): ' + ex.message); }
        });
    }

    // Estadísticas
    window.loadEstadisticas = async () => {
        const pasaportes = await db.getTable('Pasaporte');
        const establecimientos = await db.getTable('Establecimiento');
        const sellos = await db.getTable('Sello');

        document.getElementById('total-pasaportes').textContent = pasaportes.length;
        document.getElementById('total-establecimientos').textContent = establecimientos.length;
        document.getElementById('total-sellos').textContent = sellos.length;

        // Calculo complejos (requiere agrupar por JS ya que Supabase free tiene limites en queries complejas)
        const counts = {};
        sellos.forEach(s => {
            if(!counts[s.id_pasaporte]) counts[s.id_pasaporte] = new Set();
            counts[s.id_pasaporte].add(s.id_establecimiento);
        });
        const completos = Object.values(counts).filter(set => set.size >= 4).length;
        document.getElementById('pasaportes-completos').textContent = completos;
    };

    // Sorting (Simplificado para tablas HTML cargadas)
    window.sortTable = function(tableId, colIndex, type) {
        const table = document.getElementById(tableId);
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        let dir = 'asc';
        if (currentSort.tableId === tableId && currentSort.columnIndex === colIndex) {
            dir = currentSort.direction === 'asc' ? 'desc' : 'asc';
        }
        currentSort = { tableId, columnIndex: colIndex, direction: dir, type };
        
        rows.sort((a, b) => {
            const aTxt = a.cells[colIndex].textContent.trim();
            const bTxt = b.cells[colIndex].textContent.trim();
            if (type === 'number') return dir === 'asc' ? aTxt - bTxt : bTxt - aTxt;
            // Date parse DD/MM/AAAA
            if (type === 'date') {
                const p = t => { const parts = t.split('/'); return new Date(parts[2], parts[1]-1, parts[0]).getTime(); }
                return dir === 'asc' ? p(aTxt) - p(bTxt) : p(bTxt) - p(aTxt);
            }
            return dir === 'asc' ? aTxt.localeCompare(bTxt) : bTxt.localeCompare(aTxt);
        });
        rows.forEach(r => tbody.appendChild(r));
    };

    // Load inicial
    loadPage();
    document.getElementById('search-input').addEventListener('input', filterEstablecimientos);
    document.querySelectorAll('.password-container i').forEach(icon => {
        icon.addEventListener('click', function() {
            const input = this.previousElementSibling;
            input.type = input.type === 'password' ? 'text' : 'password';
            this.classList.toggle('fa-eye'); this.classList.toggle('fa-eye-slash');
        });
    });
});
</script>
</body>
</html>
